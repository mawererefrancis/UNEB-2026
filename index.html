<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>UNEB Analytics ¬∑ Mawerere Francis</title>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    /* ========== RESET & GLOBAL ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(145deg, #f6f8fc 0%, #edf0f5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #0a1e3c;
    }

    /* ========== LOGIN ========== */
    #loginBox {
      background: white;
      width: 90%;
      max-width: 380px;
      margin: auto;
      padding: 2.2rem 1.8rem;
      border-radius: 32px;
      box-shadow: 0 20px 40px -12px rgba(0,20,50,0.25);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
    }
    #loginBox h2 {
      font-weight: 600;
      font-size: 1.9rem;
      margin-bottom: 1.5rem;
      color: #0b2d5c;
      border-bottom: 3px solid #2d68c4;
      display: inline-block;
      padding-bottom: 6px;
    }
    #loginBox input {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      border: 1px solid #cbd5e1;
      border-radius: 60px;
      font-size: 1rem;
      background: #f8fafc;
      transition: 0.2s;
    }
    #loginBox input:focus {
      border-color: #1e3a8a;
      outline: none;
      box-shadow: 0 0 0 4px rgba(30,58,138,0.1);
      background: white;
    }
    #loginBox button {
      background: #0a2c4e;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.15s;
    }
    #loginBox button:hover {
      background: #143b6b;
      transform: scale(0.98);
      box-shadow: 0 8px 16px rgba(0,40,80,0.2);
    }
    #loginError { margin-top:14px; font-weight:500; color:#b91c1c; }

    /* ========== MAIN APP ========== */
    #app {
      display: none;
      width: 100%;
      max-width: 1480px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    .school-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      background: white;
      padding: 18px 28px;
      border-radius: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 18px -8px rgba(0,20,40,0.12);
      border-left: 8px solid #2563eb;
    }
    .school-name { font-size:1.8rem; font-weight:700; color:#0b2b5e; line-height:1.2; }
    .exam-year { font-size:1.4rem; font-weight:600; color:#2563eb; background:#e6f0ff; padding:6px 18px; border-radius:60px; }
    .uneb-subhead { text-align:center; font-size:1.2rem; font-weight:500; color:#334155; margin-top:4px; width:100%; }

    .action-bar {
      background: white;
      padding: 16px 24px;
      border-radius: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .action-bar input, .action-bar button {
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid #dbe0e8;
      font-size: 0.95rem;
    }
    .action-bar input { background:#f9fcff; flex:1 1 160px; }
    .action-bar button {
      background: #1e3a8a;
      color: white;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s;
      box-shadow: 0 4px 6px rgba(0,50,100,0.1);
    }
    .action-bar button:hover { background:#15306b; transform:translateY(-2px); }
    .logout-btn { background:#6b2e1e !important; }

    /* ----- TESTIMONIAL SETTINGS PANEL ----- */
    .settings-toggle {
      background: #f0f4fa;
      border-radius: 20px;
      padding: 8px 20px;
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    .settings-panel {
      background: white;
      border-radius: 20px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: none;
      flex-wrap: wrap;
      gap: 20px;
      border: 1px solid #d4e0ec;
      box-shadow: 0 6px 12px rgba(0,0,0,0.02);
    }
    .settings-panel.show { display: flex; }
    .setting-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .setting-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1e3a5f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .setting-group input, .setting-group textarea {
      padding: 10px 14px;
      border-radius: 16px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      width: 100%;
    }
    .setting-group textarea { min-height: 60px; resize: vertical; }

    /* ----- PROGRESS BARS ----- */
    .progress-container {
      width: 100%;
      background: #eef2f6;
      border-radius: 50px;
      margin-top: 16px;
      padding: 2px;
      display: none;
    }
    .progress-bar {
      height: 20px;
      background: #0f5c4b;
      border-radius: 50px;
      width: 0%;
      transition: width 0.2s;
      color: white;
      font-size: 12px;
      text-align: center;
      line-height: 20px;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ----- CANDIDATE LIST (QUICK PRINT) ----- */
    .candidate-list-section {
      background: white;
      border-radius: 24px;
      padding: 20px 24px;
      margin-bottom: 28px;
      box-shadow: 0 8px 18px -8px rgba(0,20,40,0.12);
    }
    .candidate-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 12px;
    }
    .candidate-table th {
      background: #2563eb;
      color: white;
      padding: 10px 6px;
      text-align: left;
    }
    .candidate-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #d1d9e6;
    }
    .candidate-table tr:hover {
      background: #f0f7ff;
    }
    .print-btn {
      background: #0f5c4b;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .print-btn:hover {
      background: #0a463a;
    }

    /* ----- PRINT CONTAINER (for individual testimonials) ----- */
    .print-testimonial {
      display: none;
    }

    /* ----- ANALYTICS TABLES ‚Äì FULLY RESTORED WITH PERCENTAGES ----- */
    .print-page {
      background: white;
      padding: 20px 22px;
      border-radius: 24px;
      box-shadow: 0 20px 30px -8px rgba(0,20,50,0.15);
      margin-bottom: 28px;
      display: flex;
      flex-direction: column;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
      border: 1px solid #b0c4ce;
    }
    th {
      background: #0a2c4e;
      color: white;
      font-weight: 600;
      padding: 10px 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #b0c4ce;
    }
    td {
      padding: 8px 6px;
      border: 1px solid #b0c4ce;
      text-align: center;
      vertical-align: middle;
    }
    tfoot td {
      background: #eef4ff;
      font-weight: 700;
      color: #0a2c4e;
      border: 1px solid #9ab3d8;
    }
    .project-row { background: #e6f0ff !important; font-weight:600; }
    .signature-block {
      margin-top: 24px;
      border-top: 2px dashed #9bb0cc;
      padding-top: 18px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 12px;
      color: #1e3a5f;
    }
    .signature-line { font-size:13px; font-weight:500; }
    .summary-cards {
      display: flex;
      gap: 24px;
      justify-content: flex-start;
      margin: 8px 0 0;
    }
    .card {
      background: linear-gradient(135deg, #eef4ff, #e6f0fc);
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      color: #0a2c4e;
      border: 1px solid white;
    }

    /* ========== TESTIMONIAL PAGE ‚Äì ONE PAGE, PRINT OPTIMIZED ========== */
    .testimonial-page {
      width: 210mm;
      min-height: 297mm;
      padding: 5mm 5mm 5mm;
      background: white;
      font-family: 'Times New Roman', Times, serif;
      margin: 0 auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      border: 4px double #1e3a5f;
      border-radius: 8px;
      page-break-inside: avoid;
      page-break-after: avoid;
    }
    .testimonial-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0px;
      background: linear-gradient(to right, #eef7ff, #ffffff);
      padding: 4px 6px;
      border-bottom: 2px solid #2563eb;
      border-radius: 6px 6px 0 0;
    }
    .logo-box {
      width: 65px;
      height: 65px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #aac7e0;
      border-radius: 6px;
      padding: 3px;
    }
    .logo-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .logo-placeholder {
      font-size: 8px;
      color: #3a6275;
      text-align: center;
      text-transform: uppercase;
      font-weight: 600;
    }
    .school-info {
      text-align: center;
      flex: 1;
      margin: 0 4px;
    }
    .school-name-large {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #0b2b5e;
      line-height: 1.1;
    }
    .school-address {
      font-size: 10px;
      font-weight: 600;
      color: #2c4e6b;
    }
    .school-vision, .school-mission, .school-motto {
      font-size: 8px;
      font-style: italic;
      color: #2e475d;
    }
    .testimonial-date {
      text-align: right;
      margin-top: 2px;
      margin-bottom: 0;
      font-size: 10px;
      font-weight: bold;
      color: #1e3a5f;
    }
    .testimonial-title {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      text-decoration: underline;
      text-decoration-color: #2563eb;
      text-underline-offset: 4px;
      margin: 4px 0 6px;
      color: #0b2b5e;
      letter-spacing: 1px;
    }
    .candidate-details {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin: 2px 4px 2px;
      flex-wrap: nowrap;
      white-space: nowrap;
    }
    .lin-row {
      margin: 3px 0 6px;
      font-size: 13px;
      display: flex;
      justify-content: center;
      align-items: baseline;
      width: 100%;
    }
    .lin-label {
      font-weight: bold;
      margin-right: 5px;
      white-space: nowrap;
      color: #0b2b5e;
    }
    .lin-dots {
      width: 180px;
      border-bottom: 2px dotted #1e3a5f;
      margin-left: 4px;
      height: 1.1em;
    }
    .subject-table {
      width: 100%;
      border-collapse: collapse;
      margin: 2px 0 6px;
      border: 2px solid #1e3a5f;
      table-layout: fixed;
    }
    .subject-table th {
      background: linear-gradient(to bottom, #2563eb, #1e3a8a);
      color: white;
      border: 1px solid #0b2b5e;
      padding: 4px 2px;
      font-size: 10px;
      text-transform: uppercase;
    }
    .subject-table td {
      border: 1px solid #5f7d9c;
      padding: 3px 2px;
      font-size: 10px;
      background-color: #fdfdfe;
    }
    .subject-table tr:nth-child(even) td { background-color: #f4f9ff; }
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: bold;
      margin: 3px 0 8px;
      color: #0b2b5e;
      padding: 4px 12px;
      background: #eaf0fa;
      border-radius: 40px;
    }
    .signature-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-top: 8px;
      width: 100%;
    }
    .signature-inner {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: fit-content;
    }
    .signature-line-sign {
      border-top: 2px solid #0b2b5e;
      width: 190px;
      margin-bottom: 4px;
    }
    .signature-name {
      font-size: 13px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #0b2b5e;
    }
    .signature-title, .signature-rank { font-size: 11px; }

    /* ========== PRINT STYLES ‚Äì ANALYTICS TABLES ONLY, TWO PAGES ========== */
    @media print {
      body * {
        visibility: hidden;
      }
      #schoolHeaderContainer,
      #reportArea,
      #schoolHeaderContainer *,
      #reportArea * {
        visibility: visible;
      }
      #schoolHeaderContainer,
      #reportArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
      }
      .print-testimonial {
        display: none !important;
      }
      @page {
        size: A4 landscape;
        margin: 12mm 12mm 10mm 12mm;
      }
      .print-page {
        page-break-after: always;
        box-shadow: none;
        border-radius: 0;
        padding: 5px 10px;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100%;
      }
      .print-page:last-child {
        page-break-after: avoid;
      }
      table {
        font-size: 9pt !important;
        margin: 8px 0;
      }
      th {
        padding: 5px 2px !important;
        font-size: 8.5pt !important;
        background: #0a2c4e !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      td {
        padding: 5px 2px !important;
      }
      .signature-block {
        margin-top: auto;
        border-top: 1.5px solid #3a5e7a;
        font-size: 9pt;
      }
      .summary-cards {
        margin-top: 4px;
      }
    }
  </style>
</head>
<body>

<div id="loginBox">
  <h2>üìä UNEB</h2>
  <input id="username" placeholder="Username" value="admin">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="login()">üîê Sign in</button>
  <p id="loginError"></p>
  <div style="margin-top: 12px; color: #4a6479; font-size: 0.85rem;">use admin / 1234</div>
</div>

<div id="app">

  <div id="schoolHeaderContainer" class="school-header"></div>

  <div class="action-bar">
    <input id="schoolName" placeholder="School name" value="MAWERERE MEMORIAL SCHOOL">
    <input id="year" placeholder="Year" value="2025">
    <input type="file" id="file" accept=".xlsx,.xls,.csv">
    <button onclick="generateReport()"><span>üìÇ</span> GENERATE REPORT</button>
    <button onclick="printReport()"><span>üñ®Ô∏è</span> PRINT</button>
    <button onclick="downloadPDF()"><span>üìÑ</span> EXPORT PDF</button>
    <button onclick="exportExcel()"><span>üìä</span> EXCEL (2 TABLES)</button>
    <button class="logout-btn" onclick="logout()"><span>üö™</span> LOGOUT</button>
  </div>

  <div class="settings-toggle">
    <span style="font-weight:600;">üìú TESTIMONIAL SETTINGS</span>
    <button onclick="toggleSettings()" style="background:#2d5a7a;">‚öôÔ∏è Configure</button>
  </div>

  <div id="testimonialSettings" class="settings-panel">
    <div class="setting-group">
      <label>Left Logo</label>
      <input type="file" id="logoLeft" accept="image/*">
    </div>
    <div class="setting-group">
      <label>Right Logo</label>
      <input type="file" id="logoRight" accept="image/*">
    </div>
    <div class="setting-group">
      <label>School Name</label>
      <input type="text" id="testSchoolName" value="RUBONGI ARMY SECONDARY SCHOOL">
    </div>
    <div class="setting-group">
      <label>P.O.BOX / ADDRESS</label>
      <input type="text" id="schoolAddress" value="P.O.BOX 698 TORORO">
    </div>
    <div class="setting-group">
      <label>Telephone 1</label>
      <input type="text" id="tel1" value="0782651148">
    </div>
    <div class="setting-group">
      <label>Telephone 2</label>
      <input type="text" id="tel2" value="0788222315">
    </div>
    <div class="setting-group">
      <label>Website</label>
      <input type="text" id="website" value="www.rubongiarmy.sc.ug">
    </div>
    <div class="setting-group">
      <label>Vision</label>
      <textarea id="vision">To produce a morally upright and self reliant future generation.</textarea>
    </div>
    <div class="setting-group">
      <label>Mission</label>
      <textarea id="mission">To provide affordable quality education to our community</textarea>
    </div>
    <div class="setting-group">
      <label>Motto</label>
      <textarea id="motto">Discipline, Excellence, Service</textarea>
    </div>
    <div class="setting-group">
      <label>Head Teacher Name</label>
      <input type="text" id="htName" value="ZAINA .K. NALUKENGE">
    </div>
    <div class="setting-group">
      <label>Head Title</label>
      <input type="text" id="htTitle" value="Maj.">
    </div>
    <div class="setting-group">
      <label>Head Rank</label>
      <input type="text" id="htRank" value="HEAD TEACHER">
    </div>

    <!-- BULK GENERATION BUTTONS -->
    <div style="flex:1 1 100%; display:flex; flex-direction:column; gap:20px;">
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:16px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="generatePdfBtn" onclick="generateTestimonialPDFs()" style="background:#0f5c4b; padding:14px 32px;">
            üì¶ BULK PDFs (ZIP)
          </button>
          <button id="generateWordBtn" onclick="generateTestimonialWordSingle()" style="background:#1e5f7a; padding:14px 32px;">
            üìÑ BULK WORD (single file)
          </button>
        </div>
        <div id="pdfProgressContainer" class="progress-container">
          <div id="pdfProgressBar" class="progress-bar">0%</div>
        </div>
        <div id="wordProgressContainer" class="progress-container">
          <div id="wordProgressBar" class="progress-bar">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CANDIDATE LIST ‚Äì QUICK PRINT -->
  <div id="candidateListSection" class="candidate-list-section" style="display:none;">
    <h3 style="color:#0a2c4e; margin-bottom:12px;">üñ®Ô∏è Quick Print ‚Äì Click to print testimonial</h3>
    <div style="max-height:400px; overflow-y:auto; border:1px solid #d1d9e6; border-radius:12px;">
      <table class="candidate-table">
        <thead>
          <tr><th>Index No</th><th>Candidate Name</th><th>Action</th></tr>
        </thead>
        <tbody id="candidateTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- HIDDEN PRINT CONTAINER (for individual testimonial prints) -->
  <div id="printContainer" class="print-testimonial"></div>

  <!-- REPORT AREA ‚Äì ANALYTICS TABLES (WITH PERCENTAGES) -->
  <div id="reportArea"></div>
</div>

<script>
  // ==================== GLOBAL DATA ====================
  let subjects = {};   
  let gender = {};    
  let projectTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
  let lastLoadedRows = null;

  // ==================== LOGIN / LOGOUT ====================
  function login() {
    if (username.value === "admin" && password.value === "1234") {
      loginBox.style.display = "none";
      app.style.display = "block";
    } else {
      loginError.innerText = "‚úò Use admin / 1234";
    }
  }
  function logout() {
    app.style.display = "none";
    loginBox.style.display = "block";
    username.value = "admin";
    password.value = "1234";
    loginError.innerText = "";
  }
  function toggleSettings() {
    document.getElementById('testimonialSettings').classList.toggle('show');
  }

  // ==================== GENERATE REPORT ‚Äì ACCURATE PROJECT COUNTS ====================
  function generateReport() {
    const file = document.getElementById('file').files[0];
    if (!file) { alert('Please select the UNEB Excel annex'); return; }

    const reader = new FileReader();
    reader.onload = function (e) {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      lastLoadedRows = rows;

      subjects = {};
      gender = {};
      projectTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };

      rows.forEach(row => {
        const sex = String(row.Sex || '').toUpperCase().trim();
        const project = String(row['PROJECT WORK'] || 'X').toUpperCase().trim();
        const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();
        if (!achievements) return;

        const validGrades = ['A','B','C','D','E','X'];
        const pg = validGrades.includes(project) ? project : 'X';
        
        projectTotals['P' + pg]++;

        achievements.split(' ').forEach(item => {
          if (!item.includes('-')) return;
          const [subjectRaw, gradeRaw] = item.split('-');
          const subject = subjectRaw.toUpperCase().trim();
          const g = validGrades.includes(gradeRaw) ? gradeRaw : 'X';

          if (!subjects[subject]) {
            subjects[subject] = { sat:0, A:0, B:0, C:0, D:0, E:0, X:0 };
          }
          subjects[subject].sat++;
          subjects[subject][g]++;

          if (!gender[subject]) {
            gender[subject] = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
          }
          if (sex === 'M' && g !== 'X') gender[subject]['M' + g]++;
          if (sex === 'F' && g !== 'X') gender[subject]['F' + g]++;
        });
      });

      const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
      const year = document.getElementById('year').value || '';
      document.getElementById('schoolHeaderContainer').innerHTML = `
        <span class="school-name">${schoolName}</span>
        <span class="exam-year">üìÜ ${year}</span>
        <div class="uneb-subhead">UGANDA NATIONAL EXAMINATIONS BOARD ¬∑ ANALYSIS</div>
      `;

      renderReportPages();
      renderCandidateList();
      document.getElementById('candidateListSection').style.display = 'block';
    };
    reader.readAsArrayBuffer(file);
  }

  // ==================== BUILD SUBJECT TABLE (WITH PERCENTAGES IN TOTAL ROW) ====================
  function buildSubjectTableHTML() {
    let totals = { A:0, B:0, C:0, D:0, E:0 };
    let totalSatOverall = 0;
    let html = `<h3 style="color:#0a2c4e; border-left:6px solid #2563eb; padding-left:12px; margin-bottom:6px;">üìã TABLE 1: SUBJECT PERFORMANCE SUMMARY</h3>`;
    html += `<table>
      <thead>
        <tr>
          <th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th>
          <th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th>
        </tr>
      </thead>
      <tbody>`;

    let sorted = Object.keys(subjects).sort((a,b) => 
      (subjects[b].A / subjects[b].sat) - (subjects[a].A / subjects[a].sat)
    );

    sorted.forEach((s, i) => {
      let x = subjects[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      totalSatOverall += x.sat;
      let p = (grade) => x.sat ? ((x[grade] / x.sat) * 100).toFixed(1) : '0.0';

      html += `<tr>
        <td><strong>${i+1}</strong></td>
        <td style="font-weight:600;">${s}</td>
        <td>${x.sat}</td>
        <td>${x.A}</td><td>${p('A')}%</td>
        <td>${x.B}</td><td>${p('B')}%</td>
        <td>${x.C}</td><td>${p('C')}%</td>
        <td>${x.D}</td><td>${p('D')}%</td>
        <td>${x.E}</td><td>${p('E')}%</td>
        <td>${x.X}</td>
      </tr>`;
    });

    // PROJECT WORK ROW ‚Äì using global projectTotals (accurate)
    html += `<tr class="project-row" style="background: #e3effa; font-weight: 600;">
      <td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${projectTotals.PA}</td><td></td><td>${projectTotals.PB}</td><td></td>
      <td>${projectTotals.PC}</td><td></td><td>${projectTotals.PD}</td><td></td>
      <td>${projectTotals.PE}</td><td></td><td>${projectTotals.PX}</td>
    </tr>`;

    // TOTAL ROW ‚Äì now includes percentages
    html += `<tfoot>
      <tr>
        <td></td><td><strong>TOTAL (A‚ÄìE)</strong></td><td></td>
        <td>${totals.A}</td>
        <td>${totalSatOverall ? ((totals.A / totalSatOverall) * 100).toFixed(1) : '0.0'}%</td>
        <td>${totals.B}</td>
        <td>${totalSatOverall ? ((totals.B / totalSatOverall) * 100).toFixed(1) : '0.0'}%</td>
        <td>${totals.C}</td>
        <td>${totalSatOverall ? ((totals.C / totalSatOverall) * 100).toFixed(1) : '0.0'}%</td>
        <td>${totals.D}</td>
        <td>${totalSatOverall ? ((totals.D / totalSatOverall) * 100).toFixed(1) : '0.0'}%</td>
        <td>${totals.E}</td>
        <td>${totalSatOverall ? ((totals.E / totalSatOverall) * 100).toFixed(1) : '0.0'}%</td>
        <td></td>
      </tr>
    </tfoot></table>`;

    // ANALYTICS CARDS
    let totalA = totals.A, totalSat = totalSatOverall;
    let mean = totalSat ? (totalA / totalSat * 100) : 0;
    let comment = mean >= 40 ? 'üèÜ Excellent Performance' : (mean >= 25 ? 'üìà Good Performance' : 'üìâ Needs Improvement');

    html += `<div class="summary-cards">
      <div class="card">üéì School %A : ${mean.toFixed(1)}%</div>
      <div class="card">${comment}</div>
    </div>`;

    return html;
  }

  // ==================== BUILD GENDER TABLE ‚Äì CORRECTED PERCENTAGES ====================
  function buildGenderTableHTML() {
    let grand = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };

    let html = `<h3 style="color:#0a2c4e; border-left:6px solid #2563eb; padding-left:12px; margin-bottom:6px;">‚ö• TABLE 2: GENDER DISTRIBUTION BY SUBJECT</h3>`;
    html += `<table>
      <thead>
        <tr>
          <th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
          <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
        </tr>
      </thead>
      <tbody>`;

    Object.keys(gender).sort().forEach(s => {
      let g = gender[s];
      Object.keys(grand).forEach(k => grand[k] += g[k] || 0);
      html += `<tr>
        <td style="font-weight:600;">${s}</td>
        <td>${g.MA || 0}</td><td>${g.MB || 0}</td><td>${g.MC || 0}</td><td>${g.MD || 0}</td><td>${g.ME || 0}</td>
        <td>${g.FA || 0}</td><td>${g.FB || 0}</td><td>${g.FC || 0}</td><td>${g.FD || 0}</td><td>${g.FE || 0}</td>
      </tr>`;
    });

    // Compute totals for each gender
    let totalMale = grand.MA + grand.MB + grand.MC + grand.MD + grand.ME;
    let totalFemale = grand.FA + grand.FB + grand.FC + grand.FD + grand.FE;

    // TOTAL ROW (counts)
    html += `<tfoot>
      <tr style="background: #eef4ff;">
        <td><strong>TOTAL</strong></td>
        <td>${grand.MA}</td><td>${grand.MB}</td><td>${grand.MC}</td><td>${grand.MD}</td><td>${grand.ME}</td>
        <td>${grand.FA}</td><td>${grand.FB}</td><td>${grand.FC}</td><td>${grand.FD}</td><td>${grand.FE}</td>
      </tr>`;

    // MALE PERCENTAGE ROW (sums to 100% of male subject entries)
    html += `<tr style="background: #f0f5fa; font-weight:600;">
      <td><strong>Male %</strong></td>
      <td>${totalMale ? ((grand.MA / totalMale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalMale ? ((grand.MB / totalMale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalMale ? ((grand.MC / totalMale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalMale ? ((grand.MD / totalMale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalMale ? ((grand.ME / totalMale) * 100).toFixed(1) : '0.0'}%</td>
      <td colspan="5"></td> <!-- empty cells for female columns -->
    </tr>`;

    // FEMALE PERCENTAGE ROW (sums to 100% of female subject entries)
    html += `<tr style="background: #f0f5fa; font-weight:600;">
      <td><strong>Female %</strong></td>
      <td colspan="5"></td> <!-- empty cells for male columns -->
      <td>${totalFemale ? ((grand.FA / totalFemale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalFemale ? ((grand.FB / totalFemale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalFemale ? ((grand.FC / totalFemale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalFemale ? ((grand.FD / totalFemale) * 100).toFixed(1) : '0.0'}%</td>
      <td>${totalFemale ? ((grand.FE / totalFemale) * 100).toFixed(1) : '0.0'}%</td>
    </tr>`;

    html += `</tfoot></table>`;
    return html;
  }

  // ==================== SIGNATURE BLOCK ====================
  function buildSignatureBlock() {
    return `<div class="signature-block">
      <div class="signature-line">
        <span style="font-weight:700;">Signature:</span> ___________________________________<br>
        <span style="font-size:12px; color:#2d4968;">Mawerere Francis ¬∑ In charge Students Data</span>
      </div>
      <div class="signature-contact">
        üìû 0788222315 &nbsp; ‚úâÔ∏è mawererefrancis@gmail.com
      </div>
    </div>`;
  }

  // ==================== RENDER TWO PAGES (ANALYTICS) ====================
  function renderReportPages() {
    let html = `<div class="print-page">${buildSubjectTableHTML()}${buildSignatureBlock()}</div>`;
    html += `<div class="print-page">${buildGenderTableHTML()}${buildSignatureBlock()}</div>`;
    document.getElementById('reportArea').innerHTML = html;
  }

  // ==================== PRINT ‚Äì ANALYTICS TABLES ONLY, TWO PAGES ====================
  function printReport() {
    window.print();
  }

  // ==================== PDF / EXCEL ====================
  function downloadPDF() {
    const element = document.getElementById('reportArea');
    element.classList.add('pdf-export-mode');
    html2pdf().set({ 
      margin:[8,10,5,10], 
      filename:'UNEB_ANALYSIS_MAWERERE.pdf', 
      image:{type:'jpeg',quality:0.95}, 
      html2canvas:{scale:0.58,letterRendering:true,useCORS:true}, 
      jsPDF:{unit:'mm',format:'a4',orientation:'landscape'} 
    }).from(element).save().then(() => element.classList.remove('pdf-export-mode'));
  }
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const subjectTable = document.querySelector('#reportArea .print-page:first-child table');
    if (subjectTable) { 
      const ws = XLSX.utils.table_to_sheet(subjectTable); 
      XLSX.utils.sheet_add_aoa(ws, [['SUBJECT ACHIEVEMENT SUMMARY']], { origin:'A1' }); 
      XLSX.utils.book_append_sheet(wb, ws, 'Subject Summary'); 
    }
    const genderTable = document.querySelector('#reportArea .print-page:last-child table');
    if (genderTable) { 
      const ws = XLSX.utils.table_to_sheet(genderTable); 
      XLSX.utils.sheet_add_aoa(ws, [['GENDER DISTRIBUTION']], { origin:'A1' }); 
      XLSX.utils.book_append_sheet(wb, ws, 'Gender Summary'); 
    }
    const school = document.getElementById('schoolName').value || 'SCHOOL'; 
    const year = document.getElementById('year').value || '';
    XLSX.writeFile(wb, `UNEB_${school.replace(/\s/g,'_')}_${year||'report'}.xlsx`);
  }

  // ==================== CANDIDATE LIST (QUICK PRINT) ====================
  function renderCandidateList() {
    if (!lastLoadedRows) return;
    const tbody = document.getElementById('candidateTableBody');
    tbody.innerHTML = '';
    lastLoadedRows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.IndexNo || ''}</td>
        <td>${row.Candidate_Name || ''}</td>
        <td><button class="print-btn" onclick="printSingleTestimonial('${escapeString(row.IndexNo || '')}', '${escapeString(row.Candidate_Name || '')}', '${escapeString(row.Result || '')}', '${escapeString(row['PROJECT WORK'] || 'X')}', '${escapeString(row['SUBJECT ACHIEVEMENTS'] || '')}')">üñ®Ô∏è Print</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeString(str) {
    return str.replace(/'/g, "\\'");
  }

  // ==================== PRINT SINGLE TESTIMONIAL ====================
  async function printSingleTestimonial(indexNo, candidateName, resultOverall, projectGrade, achievements) {
    const settings = {
      schoolName: document.getElementById('testSchoolName').value || 'RUBONGI ARMY SECONDARY SCHOOL',
      address: document.getElementById('schoolAddress').value || 'P.O.BOX 698 TORORO',
      tel1: document.getElementById('tel1').value || '0782651148',
      tel2: document.getElementById('tel2').value || '0788222315',
      website: document.getElementById('website').value || 'www.rubongiarmy.sc.ug',
      vision: document.getElementById('vision').value || 'To produce a morally upright and self reliant future generation.',
      mission: document.getElementById('mission').value || 'To provide affordable quality education to our community',
      motto: document.getElementById('motto').value || 'Discipline, Excellence, Service',
      htName: document.getElementById('htName').value || 'ZAINA .K. NALUKENGE',
      htTitle: document.getElementById('htTitle').value || 'Maj.',
      htRank: document.getElementById('htRank').value || 'HEAD TEACHER'
    };

    const logoLeftFile = document.getElementById('logoLeft').files[0];
    const logoRightFile = document.getElementById('logoRight').files[0];
    let logoLeftData = null, logoRightData = null;
    if (logoLeftFile) logoLeftData = await readFileAsDataURL(logoLeftFile);
    if (logoRightFile) logoRightData = await readFileAsDataURL(logoRightFile);

    const currentDate = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' });

    const subjectsList = [];
    if (achievements) {
      achievements.split(' ').forEach(item => {
        if (item.includes('-')) {
          let [sub, grad] = item.split('-');
          subjectsList.push([sub.trim(), grad.trim()]);
        }
      });
    }

    const testimonialHTML = `
      <div class="testimonial-page" style="margin:0 auto; width:210mm;">
        <div class="testimonial-header">
          <div class="logo-box">${logoLeftData ? `<img src="${logoLeftData}" alt="Logo">` : '<span class="logo-placeholder">SCHOOL<br>LOGO</span>'}</div>
          <div class="school-info">
            <div class="school-name-large">${settings.schoolName}</div>
            <div class="school-address">${settings.address}  TEL: ${settings.tel1} / ${settings.tel2}</div>
            <div class="school-address">${settings.website}</div>
            <div class="school-vision">VISION: <em>${settings.vision}</em></div>
            <div class="school-mission">MISSION: <em>${settings.mission}</em></div>
            <div class="school-motto">MOTTO: <em>${settings.motto}</em></div>
          </div>
          <div class="logo-box">${logoRightData ? `<img src="${logoRightData}" alt="Logo">` : '<span class="logo-placeholder">SCHOOL<br>LOGO</span>'}</div>
        </div>
        <div class="testimonial-date"><strong>DATE:</strong> ${currentDate}</div>
        <div class="testimonial-title">NLSC TESTIMONIAL 2026</div>
        <div class="candidate-details">
          <span><strong>NAME:</strong> ${candidateName}</span>
          <span><strong>INDEX NO:</strong> ${indexNo}</span>
        </div>
        <div class="lin-row">
          <span class="lin-label"><strong>LIN:</strong></span>
          <span class="lin-dots"></span>
        </div>
        <table class="subject-table">
          <thead><tr><th>S/NO</th><th>SUBJECT</th><th>SUBJECT ACHIEVEMENT</th></tr></thead>
          <tbody>
            ${subjectsList.length > 0 
              ? subjectsList.map(([sub, grade], idx) => `<tr><td>${idx+1}</td><td>${sub}</td><td style="font-weight:bold; text-align:center;">${grade}</td></tr>`).join('')
              : `<tr><td colspan="3" style="text-align:center; font-style:italic;">No subjects recorded</td></tr>`}
          </tbody>
        </table>
        <div class="result-row">
          <span><strong>RESULT:</strong> ${resultOverall}</span>
          <span><strong>PROJECT WORK:</strong> ${projectGrade}</span>
        </div>
        <div class="signature-wrapper">
          <div class="signature-inner">
            <div class="signature-line-sign"></div>
            <div class="signature-name">${settings.htName}</div>
            <div class="signature-title">${settings.htTitle}</div>
            <div class="signature-rank">${settings.htRank}</div>
          </div>
        </div>
      </div>
    `;

    const printContainer = document.getElementById('printContainer');
    printContainer.innerHTML = testimonialHTML;

    const images = printContainer.querySelectorAll('img');
    await Promise.all(Array.from(images).map(img => {
      if (img.complete) return Promise.resolve();
      return Promise.race([
        new Promise(resolve => { img.onload = resolve; img.onerror = resolve; }),
        new Promise(resolve => setTimeout(resolve, 2000))
      ]);
    }));

    window.print();
  }

  // ==================== BULK PDF GENERATION ====================
  async function generateTestimonialPDFs() {
    if (!lastLoadedRows || lastLoadedRows.length === 0) {
      alert('Please generate the report first');
      return;
    }

    const pdfBtn = document.getElementById('generatePdfBtn');
    const wordBtn = document.getElementById('generateWordBtn');
    pdfBtn.disabled = true; wordBtn.disabled = true;
    pdfBtn.innerHTML = '<span class="spinner"></span> GENERATING PDFs...';

    const progressContainer = document.getElementById('pdfProgressContainer');
    const progressBar = document.getElementById('pdfProgressBar');
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%'; progressBar.innerText = '0%';

    const logoLeftFile = document.getElementById('logoLeft').files[0];
    const logoRightFile = document.getElementById('logoRight').files[0];
    let logoLeftData = null, logoRightData = null;
    if (logoLeftFile) logoLeftData = await readFileAsDataURL(logoLeftFile);
    if (logoRightFile) logoRightData = await readFileAsDataURL(logoRightFile);

    const settings = {
      schoolName: document.getElementById('testSchoolName').value || 'RUBONGI ARMY SECONDARY SCHOOL',
      address: document.getElementById('schoolAddress').value || 'P.O.BOX 698 TORORO',
      tel1: document.getElementById('tel1').value || '0782651148',
      tel2: document.getElementById('tel2').value || '0788222315',
      website: document.getElementById('website').value || 'www.rubongiarmy.sc.ug',
      vision: document.getElementById('vision').value || 'To produce a morally upright and self reliant future generation.',
      mission: document.getElementById('mission').value || 'To provide affordable quality education to our community',
      motto: document.getElementById('motto').value || 'Discipline, Excellence, Service',
      htName: document.getElementById('htName').value || 'ZAINA .K. NALUKENGE',
      htTitle: document.getElementById('htTitle').value || 'Maj.',
      htRank: document.getElementById('htRank').value || 'HEAD TEACHER'
    };

    const currentDate = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' });

    const zip = new JSZip();
    const folder = zip.folder('PDF_Testimonials');
    const total = lastLoadedRows.length;
    const batchSize = 5;
    let processed = 0;

    for (let i = 0; i < total; i += batchSize) {
      const batch = lastLoadedRows.slice(i, i + batchSize);
      for (const row of batch) {
        const candidateName = row.Candidate_Name || 'Unknown';
        const indexNo = row.IndexNo || '';
        const resultOverall = row.Result || '';
        const projectGrade = row['PROJECT WORK'] || 'X';
        const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();

        const subjectsList = [];
        if (achievements) {
          achievements.split(' ').forEach(item => {
            if (item.includes('-')) {
              let [sub, grad] = item.split('-');
              subjectsList.push([sub.trim(), grad.trim()]);
            }
          });
        }

        const testimonialHTML = `
          <div class="testimonial-page">
            <div class="testimonial-header">
              <div class="logo-box">${logoLeftData ? `<img src="${logoLeftData}" alt="Logo">` : '<span class="logo-placeholder">SCHOOL<br>LOGO</span>'}</div>
              <div class="school-info">
                <div class="school-name-large">${settings.schoolName}</div>
                <div class="school-address">${settings.address}  TEL: ${settings.tel1} / ${settings.tel2}</div>
                <div class="school-address">${settings.website}</div>
                <div class="school-vision">VISION: <em>${settings.vision}</em></div>
                <div class="school-mission">MISSION: <em>${settings.mission}</em></div>
                <div class="school-motto">MOTTO: <em>${settings.motto}</em></div>
              </div>
              <div class="logo-box">${logoRightData ? `<img src="${logoRightData}" alt="Logo">` : '<span class="logo-placeholder">SCHOOL<br>LOGO</span>'}</div>
            </div>
            <div class="testimonial-date"><strong>DATE:</strong> ${currentDate}</div>
            <div class="testimonial-title">NLSC TESTIMONIAL 2026</div>
            <div class="candidate-details">
              <span><strong>NAME:</strong> ${candidateName}</span>
              <span><strong>INDEX NO:</strong> ${indexNo}</span>
            </div>
            <div class="lin-row">
              <span class="lin-label"><strong>LIN:</strong></span>
              <span class="lin-dots"></span>
            </div>
            <table class="subject-table">
              <thead><tr><th>S/NO</th><th>SUBJECT</th><th>SUBJECT ACHIEVEMENT</th></tr></thead>
              <tbody>
                ${subjectsList.length > 0 
                  ? subjectsList.map(([sub, grade], idx) => `<tr><td>${idx+1}</td><td>${sub}</td><td style="font-weight:bold; text-align:center;">${grade}</td></tr>`).join('')
                  : `<tr><td colspan="3" style="text-align:center; font-style:italic;">No subjects recorded</td></tr>`}
              </tbody>
            </table>
            <div class="result-row">
              <span><strong>RESULT:</strong> ${resultOverall}</span>
              <span><strong>PROJECT WORK:</strong> ${projectGrade}</span>
            </div>
            <div class="signature-wrapper">
              <div class="signature-inner">
                <div class="signature-line-sign"></div>
                <div class="signature-name">${settings.htName}</div>
                <div class="signature-title">${settings.htTitle}</div>
                <div class="signature-rank">${settings.htRank}</div>
              </div>
            </div>
          </div>
        `;

        const container = document.createElement('div');
        container.innerHTML = testimonialHTML;
        document.body.appendChild(container);

        const images = container.querySelectorAll('img');
        await Promise.all(Array.from(images).map(img => {
          if (img.complete) return Promise.resolve();
          return Promise.race([
            new Promise(resolve => { img.onload = resolve; img.onerror = resolve; }),
            new Promise(resolve => setTimeout(resolve, 2000))
          ]);
        }));

        try {
          const pdfBlob = await html2pdf().set({
            margin: [8,8,8,8],
            filename: `${candidateName}.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 1.8, letterRendering: true, useCORS: true, logging: false },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          }).from(container).output('blob');

          folder.file(`${sanitizeFileName(candidateName)}.pdf`, pdfBlob);
        } catch (err) {
          console.error(`PDF failed for ${candidateName}:`, err);
        }

        document.body.removeChild(container);
        processed++;
        const percent = Math.round((processed / total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.innerText = percent + '%';
        if (processed % 3 === 0) await new Promise(resolve => setTimeout(resolve, 10));
      }
      await new Promise(resolve => setTimeout(resolve, 20));
    }

    const zipBlob = await zip.generateAsync({ type: 'blob' });
    saveAs(zipBlob, `PDF_Testimonials_${settings.schoolName.replace(/\s/g,'_')}_${Date.now()}.zip`);

    pdfBtn.disabled = false; wordBtn.disabled = false;
    pdfBtn.innerHTML = 'üì¶ BULK PDFs (ZIP)';
    progressContainer.style.display = 'none';
  }

  // ==================== FAST WORD GENERATION ‚Äì SINGLE DOCUMENT ====================
  async function generateTestimonialWordSingle() {
    if (!lastLoadedRows || lastLoadedRows.length === 0) {
      alert('Please generate the report first');
      return;
    }

    const wordBtn = document.getElementById('generateWordBtn');
    const pdfBtn = document.getElementById('generatePdfBtn');
    wordBtn.disabled = true; pdfBtn.disabled = true;
    wordBtn.innerHTML = '<span class="spinner"></span> GENERATING WORD...';

    const progressContainer = document.getElementById('wordProgressContainer');
    const progressBar = document.getElementById('wordProgressBar');
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%'; progressBar.innerText = '0%';

    const settings = {
      schoolName: document.getElementById('testSchoolName').value || 'RUBONGI ARMY SECONDARY SCHOOL',
      address: document.getElementById('schoolAddress').value || 'P.O.BOX 698 TORORO',
      tel1: document.getElementById('tel1').value || '0782651148',
      tel2: document.getElementById('tel2').value || '0788222315',
      website: document.getElementById('website').value || 'www.rubongiarmy.sc.ug',
      vision: document.getElementById('vision').value || 'To produce a morally upright and self reliant future generation.',
      mission: document.getElementById('mission').value || 'To provide affordable quality education to our community',
      motto: document.getElementById('motto').value || 'Discipline, Excellence, Service',
      htName: document.getElementById('htName').value || 'ZAINA .K. NALUKENGE',
      htTitle: document.getElementById('htTitle').value || 'Maj.',
      htRank: document.getElementById('htRank').value || 'HEAD TEACHER'
    };

    const currentDate = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' });

    const { Document, Packer, Paragraph, Table, TableRow, TableCell, Border, WidthType, AlignmentType, PageBreak } = docx;
    const BorderStyle = docx.BorderStyle;
    const allBorders = {
      top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
      bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
      left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
      right: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
    };

    const children = [];
    const total = lastLoadedRows.length;

    for (let i = 0; i < total; i++) {
      const row = lastLoadedRows[i];
      const candidateName = row.Candidate_Name || 'Unknown';
      const indexNo = row.IndexNo || '';
      const resultOverall = row.Result || '';
      const projectGrade = row['PROJECT WORK'] || 'X';
      const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();

      const subjectsList = [];
      if (achievements) {
        achievements.split(' ').forEach(item => {
          if (item.includes('-')) {
            let [sub, grad] = item.split('-');
            subjectsList.push([sub.trim(), grad.trim()]);
          }
        });
      }

      children.push(
        new Paragraph({ text: settings.schoolName, heading: 'Heading1', alignment: AlignmentType.CENTER }),
        new Paragraph({ text: `${settings.address}  TEL: ${settings.tel1} / ${settings.tel2}`, alignment: AlignmentType.CENTER }),
        new Paragraph({ text: settings.website, alignment: AlignmentType.CENTER }),
        new Paragraph({ text: `VISION: ${settings.vision}`, alignment: AlignmentType.CENTER }),
        new Paragraph({ text: `MISSION: ${settings.mission}`, alignment: AlignmentType.CENTER }),
        new Paragraph({ text: `MOTTO: ${settings.motto}`, alignment: AlignmentType.CENTER }),
        new Paragraph({ text: `DATE: ${currentDate}`, alignment: AlignmentType.RIGHT }),
        new Paragraph({ text: 'NLSC TESTIMONIAL 2026', heading: 'Heading2', alignment: AlignmentType.CENTER, underline: { type: 'single' } }),
        new Paragraph({ text: `NAME: ${candidateName}     INDEX NO: ${indexNo}` }),
        new Paragraph({ text: 'LIN: __________________________________________________________________' }),
        new Paragraph('')
      );

      const tableRows = [
        new TableRow({
          children: [
            new TableCell({ children: [new Paragraph('S/NO')], borders: allBorders }),
            new TableCell({ children: [new Paragraph('SUBJECT')], borders: allBorders }),
            new TableCell({ children: [new Paragraph('SUBJECT ACHIEVEMENT')], borders: allBorders })
          ]
        })
      ];

      subjectsList.forEach(([sub, grade], idx) => {
        tableRows.push(new TableRow({
          children: [
            new TableCell({ children: [new Paragraph((idx+1).toString())], borders: allBorders }),
            new TableCell({ children: [new Paragraph(sub)], borders: allBorders }),
            new TableCell({ children: [new Paragraph({ text: grade, bold: true })], borders: allBorders })
          ]
        }));
      });

      if (subjectsList.length === 0) {
        tableRows.push(new TableRow({
          children: [
            new TableCell({ children: [new Paragraph('No subjects recorded')], columnSpan: 3, borders: allBorders })
          ]
        }));
      }

      children.push(
        new Table({ rows: tableRows, width: { size: 100, type: WidthType.PERCENTAGE } }),
        new Paragraph(''),
        new Paragraph({ text: `RESULT: ${resultOverall}     PROJECT WORK: ${projectGrade}`, alignment: AlignmentType.BOTH }),
        new Paragraph(''),
        new Paragraph({ text: settings.htName, alignment: AlignmentType.RIGHT, bold: true }),
        new Paragraph({ text: settings.htTitle, alignment: AlignmentType.RIGHT }),
        new Paragraph({ text: settings.htRank, alignment: AlignmentType.RIGHT })
      );

      if (i < total - 1) children.push(new Paragraph({ children: [new PageBreak()] }));

      const percent = Math.round(((i+1) / total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.innerText = percent + '%';
      if (i % 10 === 0) await new Promise(resolve => setTimeout(resolve, 5));
    }

    const doc = new Document({ sections: [{ properties: {}, children }] });
    const blob = await Packer.toBlob(doc);
    saveAs(blob, `Testimonials_${settings.schoolName.replace(/\s/g,'_')}_${Date.now()}.docx`);

    wordBtn.disabled = false; pdfBtn.disabled = false;
    wordBtn.innerHTML = 'üìÑ BULK WORD (single file)';
    progressContainer.style.display = 'none';
  }

  // ==================== HELPER FUNCTIONS ====================
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function sanitizeFileName(name) {
    return name.replace(/[\\/*?:"<>|]/g, '_').trim();
  }

  // ==================== GLOBAL ACCESS ====================
  window.toggleSettings = toggleSettings;
  window.generateTestimonialPDFs = generateTestimonialPDFs;
  window.generateTestimonialWordSingle = generateTestimonialWordSingle;
  window.printSingleTestimonial = printSingleTestimonial;
  window.logout = logout;
</script>
</body>
</html>
