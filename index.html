<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>UNEB Insight ¬∑ Mawerere Francis</title>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    /* ========== RESET & GLOBAL ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(145deg, #f0f5fa 0%, #e6ecf3 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #0a1e3c;
    }

    /* ========== LOGIN ‚Äì MODERN & ELEGANT ========== */
    #loginBox {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      width: 90%;
      max-width: 460px;
      margin: auto;
      padding: 2.8rem 2.2rem 2.2rem;
      border-radius: 48px;
      box-shadow: 0 30px 50px -20px rgba(0,30,70,0.4), inset 0 0 0 1px rgba(255,255,255,0.6);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.8);
    }
    #loginBox h1 {
      font-weight: 700;
      font-size: 2.4rem;
      margin-bottom: 0.2rem;
      background: linear-gradient(135deg, #0b2d5c, #2563eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    #loginBox .slogan {
      font-size: 1.1rem;
      font-weight: 400;
      color: #2c4b7a;
      margin-bottom: 2rem;
      font-style: italic;
      border-bottom: 2px solid #9bb7e0;
      display: inline-block;
      padding-bottom: 6px;
    }
    #loginBox input {
      width: 100%;
      padding: 16px 20px;
      margin: 12px 0;
      border: none;
      border-radius: 60px;
      font-size: 1rem;
      background: #f0f7ff;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.03), 0 0 0 2px transparent;
      transition: 0.2s;
    }
    #loginBox input:focus {
      outline: none;
      background: white;
      box-shadow: inset 0 2px 8px rgba(0,20,50,0.05), 0 0 0 3px #2563eb30;
    }
    #loginBox button {
      background: linear-gradient(145deg, #0b2d5c, #1e4a8c);
      color: white;
      border: none;
      padding: 16px 28px;
      border-radius: 60px;
      font-size: 1.2rem;
      font-weight: 600;
      width: 100%;
      margin-top: 24px;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 8px 20px -6px #0b2d5c80;
    }
    #loginBox button:hover {
      background: linear-gradient(145deg, #143b6b, #2563eb);
      transform: scale(0.98);
      box-shadow: 0 12px 24px -8px #0b2d5c;
    }
    #loginError { margin-top:14px; font-weight:500; color:#b91c1c; }
    .dev-credit {
      margin-top: 28px;
      font-size: 0.85rem;
      color: #1e3a5f;
      border-top: 2px dashed #a0b8d0;
      padding-top: 20px;
      line-height: 1.5;
      background: #eaf1fc;
      border-radius: 32px;
      padding: 18px 12px;
    }

    /* ========== MAIN APP ‚Äì BEAUTIFUL DASHBOARD ========== */
    #app {
      display: none;
      width: 100%;
      max-width: 1480px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    .school-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      background: white;
      padding: 20px 30px;
      border-radius: 32px;
      margin-bottom: 24px;
      box-shadow: 0 12px 28px -12px rgba(0,20,40,0.2);
      border-left: 8px solid #2563eb;
    }
    .school-name { font-size:1.9rem; font-weight:700; color:#0b2b5e; line-height:1.2; }
    .exam-year { font-size:1.5rem; font-weight:600; color:#2563eb; background:#e6f0ff; padding:6px 20px; border-radius:60px; }
    .uneb-subhead { text-align:center; font-size:1.2rem; font-weight:500; color:#334155; margin-top:4px; width:100%; }

    .action-bar {
      background: white;
      padding: 18px 28px;
      border-radius: 28px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.05);
    }
    .action-bar input, .action-bar button {
      padding: 14px 22px;
      border-radius: 50px;
      border: 1px solid #dde3ed;
      font-size: 0.95rem;
    }
    .action-bar input { background:#f9fcff; flex:1 1 160px; }
    .action-bar button {
      background: #1e3a8a;
      color: white;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: 0.15s;
      box-shadow: 0 4px 12px rgba(30,58,138,0.3);
    }
    .action-bar button:hover { background:#15306b; transform:translateY(-2px); }
    .logout-btn { background:#6b2e1e !important; box-shadow:0 4px 12px #6b2e1e60 !important; }
    
    /* Settings panel */
    .settings-toggle {
      background: #f0f4fa;
      border-radius: 28px;
      padding: 10px 24px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    .settings-panel {
      background: white;
      border-radius: 28px;
      padding: 24px 28px;
      margin-bottom: 24px;
      display: none;
      flex-wrap: wrap;
      gap: 24px;
      border: 1px solid #d4e0ec;
      box-shadow: 0 8px 18px rgba(0,0,0,0.02);
    }
    .settings-panel.show { display: flex; }
    .setting-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .setting-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1e3a5f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .setting-group input, .setting-group textarea {
      padding: 12px 16px;
      border-radius: 24px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      width: 100%;
      background: #fafdff;
    }
    .setting-group textarea { min-height: 70px; resize: vertical; }

    /* ========== ANALYTICS TABLES ‚Äì COLORFUL & PROFESSIONAL ========== */
    .print-page {
      background: white;
      padding: 8px 15px 12px 15px;
      border-radius: 32px;
      box-shadow: 0 20px 30px -8px rgba(0,20,50,0.15);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      page-break-inside: avoid;
      box-sizing: border-box;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10.5px;
      margin: 8px 0;
      border: 1px solid #9bb0cc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    th {
      background: #0a2c4e;
      color: white;
      font-weight: 600;
      padding: 6px 2px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      font-size: 9px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #9bb0cc;
    }
    td {
      padding: 4px 2px;
      border: 1px solid #b0c4de;
      text-align: center;
      vertical-align: middle;
    }
    /* Grade colors */
    .grade-A { background-color: #c8e6c9; font-weight: bold; color: #1e4a2c; }
    .grade-B { background-color: #d1e7ff; font-weight: bold; color: #0b3b6b; }
    .grade-C { background-color: #fff3cd; font-weight: bold; color: #856404; }
    .grade-D { background-color: #ffe0b2; font-weight: bold; color: #994f00; }
    .grade-E { background-color: #f9d6d6; font-weight: bold; color: #a13d3d; }
    .grade-X { background-color: #e0e0e0; color: #333; }
    td.grade-cell { text-align: center; font-weight: 600; }
    
    tfoot td {
      background: #eef4ff;
      font-weight: 700;
      color: #0a2c4e;
      border: 1px solid #9ab3d8;
    }
    .project-row { background: #e6f0ff !important; font-weight:600; }
    .signature-block {
      margin-top: 12px;
      border-top: 2px dashed #9bb0cc;
      padding-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 10px;
      color: #1e3a5f;
    }
    .signature-left {
      flex: 1;
      text-align: left;
    }
    .signature-right {
      flex: 1;
      text-align: right;
      font-weight: 500;
    }
    .signature-line {
      margin: 3px 0;
    }
    .summary-cards {
      display: flex;
      gap: 16px;
      justify-content: flex-start;
      margin: 5px 0 0;
    }
    .card {
      background: linear-gradient(135deg, #eef4ff, #e6f0fc);
      padding: 6px 18px;
      border-radius: 40px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #0a2c4e;
      border: 1px solid white;
    }
    /* Section title style (like stream title) */
    .section-title {
      background: #2563eb; 
      color: white; 
      padding: 5px 12px; 
      border-radius: 30px 30px 0 0; 
      margin: 0; 
      font-size: 1.1rem;
      display: inline-block;
    }
    .stream-title {
      background: #2563eb; 
      color: white; 
      padding: 5px 12px; 
      border-radius: 30px 30px 0 0; 
      margin: 0; 
      font-size: 1.1rem;
      display: inline-block;
    }

    /* print landscape ‚Äì perfectly fitted, high res */
    @media print {
      body * { visibility: hidden; }
      #schoolHeaderContainer, #reportArea, #schoolHeaderContainer *, #reportArea * { visibility: visible; }
      #schoolHeaderContainer, #reportArea { 
        position: absolute; 
        left: 0; 
        top: 0; 
        width: 100%; 
        background: white; 
      }
      @page { 
        size: A4 landscape; 
        margin: 6mm 6mm 4mm 6mm;  
      }
      .print-page {
        page-break-after: always;
        box-shadow: none;
        border-radius: 0;
        padding: 1mm 2mm;
        margin: 0;
        min-height: auto;
      }
      .print-page:last-child { page-break-after: avoid; }
      table { font-size: 8.5pt; border: 1px solid #333; }
      th { background: #0a2c4e !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .grade-A { background-color: #c8e6c9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .grade-B { background-color: #d1e7ff !important; }
      .grade-C { background-color: #fff3cd !important; }
      .grade-D { background-color: #ffe0b2 !important; }
      .grade-E { background-color: #f9d6d6 !important; }
      .grade-X { background-color: #e0e0e0 !important; }
    }
  </style>
</head>
<body>

<div id="loginBox">
  <h1>üìä UNEB Insight</h1>
  <div class="slogan">Feel the Power of Analytics</div>
  <input id="username" placeholder="Username" value="admin">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="login()">üîê Sign in</button>
  <p id="loginError"></p>
  <div class="dev-credit">
    <strong>DEVELOPED BY MAWERERE FRANCIS</strong><br>
    üìû 0788223215 ¬∑ WhatsApp: +256788223215<br>
    HOD ICT ¬∑ RUBONGI ARMY SECONDARY SCHOOL
  </div>
</div>

<div id="app">
  <div id="schoolHeaderContainer" class="school-header"></div>
  <div class="action-bar">
    <input id="schoolName" placeholder="School name" value="MAWERERE MEMORIAL SCHOOL">
    <input id="year" placeholder="Year" value="2025">
    <input type="file" id="file" accept=".xlsx,.xls,.csv">
    <button onclick="generateReport()"><span>üìÇ</span> GENERATE REPORT</button>
    <button onclick="printReport()"><span>üñ®Ô∏è</span> PRINT</button>
    <button onclick="downloadPDF()"><span>üìÑ</span> EXPORT PDF</button>
    <button onclick="exportExcel()"><span>üìä</span> EXCEL (ALL TABLES)</button>
    <button class="logout-btn" onclick="logout()"><span>üö™</span> LOGOUT</button>
  </div>

  <!-- Signature Settings Toggle -->
  <div class="settings-toggle">
    <span style="font-weight:600;">‚úçÔ∏è SIGNATURE SETTINGS</span>
    <button onclick="toggleSignatureSettings()" style="background:#2d5a7a;">‚öôÔ∏è Configure</button>
  </div>
  <div id="signatureSettings" class="settings-panel">
    <div class="setting-group">
      <label>Signatory Name</label>
      <input type="text" id="signatoryName" value="MAWERERE FRANCIS">
    </div>
    <div class="setting-group">
      <label>Title / Role</label>
      <input type="text" id="signatoryTitle" value="Data In charge">
    </div>
    <div class="setting-group">
      <label>Telephone</label>
      <input type="text" id="signatoryPhone" value="0788222315">
    </div>
    <div class="setting-group">
      <label>Email</label>
      <input type="text" id="signatoryEmail" value="mawererefrancis@gmail.com">
    </div>
    <div class="setting-group">
      <label>Signature Label</label>
      <input type="text" id="signatureLabel" value="Signature:">
    </div>
    <div class="setting-group">
      <label>Extra Info (optional)</label>
      <textarea id="extraSignatureInfo"></textarea>
    </div>
  </div>

  <!-- REPORT AREA ‚Äì ALL ANALYTICS TABLES -->
  <div id="reportArea"></div>
</div>

<script>
  // ==================== GLOBAL DATA ====================
  let subjects = {}; let gender = {}; let projectTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
  let lastLoadedRows = null;
  let streamData = {}; // per stream subject aggregates
  let streamProjectTotals = {}; // per stream project work aggregates
  let studentRankings = []; // for top 20

  // Core subjects for tie-breaking (ordered by importance)
  const CORE_SUBJECTS = ['ENG', 'MTC', 'BIO', 'CHEM', 'PHY', 'GEO', 'HIS'];

  // ==================== LOGIN / LOGOUT ====================
  function login() {
    if (username.value === "admin" && password.value === "1234") {
      loginBox.style.display = "none";
      app.style.display = "block";
    } else {
      loginError.innerText = "‚úò Use admin / 1234";
    }
  }
  function logout() {
    app.style.display = "none"; loginBox.style.display = "block";
    username.value = "admin"; password.value = "1234"; loginError.innerText = "";
  }
  function toggleSignatureSettings() {
    document.getElementById('signatureSettings').classList.toggle('show');
  }

  // ==================== GENERATE REPORT ‚Äì WITH ERROR HANDLING ====================
  function generateReport() {
    const file = document.getElementById('file').files[0];
    if (!file) { 
      alert('Please select the UNEB Excel annex first!'); 
      return; 
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const firstSheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' }); // empty string for missing cells

        if (!rows || rows.length === 0) {
          alert('The selected file has no data in the first sheet.');
          return;
        }

        lastLoadedRows = rows;

        // reset aggregates
        subjects = {}; gender = {}; projectTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
        streamData = {};
        streamProjectTotals = {};
        studentRankings = [];

        const validGrades = ['A','B','C','D','E','X'];

        rows.forEach(row => {
          // Normalize column access: handle possible spaces/underscores
          const sex = (row.Sex || row.sex || '').toString().toUpperCase().trim();
          const project = (row['PROJECT WORK'] || row['PROJECT_WORK'] || row.project_work || row.ProjectWork || 'X').toString().toUpperCase().trim();
          const achievements = (row['SUBJECT ACHIEVEMENTS'] || row['SUBJECT_ACHIEVEMENTS'] || row.subject_achievements || '').toString().trim();
          const stream = (row['STREAM'] || row.stream || '').toString().trim().toUpperCase();
          const indexNo = (row['IndexNo'] || row['INDEXNO'] || row.indexNo || row.Index_No || '').toString().trim();
          const candidateName = (row['Candidate_Name'] || row['CANDIDATE_NAME'] || row.candidate_name || row.CandidateName || '').toString().trim();

          if (!achievements) return; // skip rows with no subjects

          // project totals (overall)
          const pg = validGrades.includes(project) ? project : 'X';
          projectTotals['P' + pg]++;

          // Student data for ranking
          let studentSubjects = [];
          let gradeCounts = { A:0, B:0, C:0, D:0, E:0, X:0 };
          let gradePoints = { A:5, B:4, C:3, D:2, E:1, X:0 };
          let totalPoints = 0;
          let coreGrades = {};

          // process each subject
          achievements.split(' ').forEach(item => {
            if (!item.includes('-')) return;
            const [subjectRaw, gradeRaw] = item.split('-');
            const subject = subjectRaw.toUpperCase().trim();
            const g = validGrades.includes(gradeRaw) ? gradeRaw : 'X';
            
            studentSubjects.push(`${subject}-${g}`);
            gradeCounts[g]++;
            
            // overall subject aggregates
            if (!subjects[subject]) subjects[subject] = { sat:0, A:0, B:0, C:0, D:0, E:0, X:0 };
            subjects[subject].sat++; subjects[subject][g]++;

            // gender aggregates
            if (!gender[subject]) gender[subject] = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
            if (sex === 'M' && g !== 'X') gender[subject]['M' + g]++;
            if (sex === 'F' && g !== 'X') gender[subject]['F' + g]++;

            // stream aggregates (if stream exists)
            if (stream) {
              if (!streamData[stream]) streamData[stream] = { overall: { sat:0, A:0, B:0, C:0, D:0, E:0, X:0 }, subjects: {} };
              if (!streamData[stream].subjects[subject]) 
                streamData[stream].subjects[subject] = { sat:0, A:0, B:0, C:0, D:0, E:0, X:0 };
              streamData[stream].subjects[subject].sat++;
              streamData[stream].subjects[subject][g]++;
              streamData[stream].overall.sat++;
              streamData[stream].overall[g]++;
            }

            // For student ranking
            totalPoints += gradePoints[g] || 0;
            if (CORE_SUBJECTS.includes(subject)) {
              coreGrades[subject] = g;
            }
          });

          // Store student ranking info (only if at least one subject processed)
          if (studentSubjects.length > 0) {
            studentRankings.push({
              indexNo,
              name: candidateName,
              sex,
              gradeCounts: { ...gradeCounts },
              coreGrades,
              totalPoints,
              subjects: studentSubjects.join(', ')
            });
          }

          // Stream project work totals
          if (stream) {
            if (!streamProjectTotals[stream]) {
              streamProjectTotals[stream] = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
            }
            streamProjectTotals[stream]['P' + pg]++;
          }
        });

        // Sort student rankings by new criteria
        studentRankings.sort((a, b) => {
          if (a.gradeCounts.A !== b.gradeCounts.A) return b.gradeCounts.A - a.gradeCounts.A;
          if (a.gradeCounts.B !== b.gradeCounts.B) return b.gradeCounts.B - a.gradeCounts.B;
          if (a.gradeCounts.C !== b.gradeCounts.C) return b.gradeCounts.C - a.gradeCounts.C;
          if (a.gradeCounts.D !== b.gradeCounts.D) return b.gradeCounts.D - a.gradeCounts.D;
          
          // Compare core subjects in defined order
          for (let subj of CORE_SUBJECTS) {
            let gradeA = a.coreGrades[subj] || 'X';
            let gradeB = b.coreGrades[subj] || 'X';
            let valA = { A:5, B:4, C:3, D:2, E:1, X:0 }[gradeA];
            let valB = { A:5, B:4, C:3, D:2, E:1, X:0 }[gradeB];
            if (valA !== valB) return valB - valA;
          }
          return b.totalPoints - a.totalPoints;
        });

        // Update header
        const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
        const year = document.getElementById('year').value || '';
        document.getElementById('schoolHeaderContainer').innerHTML = `
          <span class="school-name">${schoolName}</span>
          <span class="exam-year">üìÜ ${year}</span>
          <div class="uneb-subhead">UGANDA NATIONAL EXAMINATIONS BOARD ¬∑ ANALYSIS</div>
        `;

        renderReportPages();
        alert('Report generated successfully!'); // feedback
      } catch (error) {
        console.error('Error during report generation:', error);
        alert('An error occurred while processing the file. Please check the console (F12) for details.');
      }
    };
    reader.onerror = function() {
      alert('Failed to read the file. Please try again.');
    };
    reader.readAsArrayBuffer(file);
  }

  // ========== BUILD SUBJECT TABLE (now with section-title) ==========
  function buildSubjectTableHTML() {
    let totals = { A:0, B:0, C:0, D:0, E:0 };
    let totalSatOverall = 0;
    let html = `<h3 class="section-title">üìã SUBJECT PERFORMANCE SUMMARY (ALL STREAMS)</h3>`;
    html += `<table>
      <thead><tr><th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th><th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th></tr></thead>
      <tbody>`;

    let sorted = Object.keys(subjects).sort((a,b) => (subjects[b].A/subjects[b].sat) - (subjects[a].A/subjects[a].sat));
    sorted.forEach((s, i) => {
      let x = subjects[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      totalSatOverall += x.sat;
      let p = (grade) => x.sat ? ((x[grade] / x.sat) * 100).toFixed(1) : '0.0';
      html += `<tr><td><strong>${i+1}</strong></td><td style="font-weight:600;">${s}</td><td>${x.sat}</td>
        <td class="grade-cell grade-A">${x.A}</td><td class="grade-cell grade-A">${p('A')}%</td>
        <td class="grade-cell grade-B">${x.B}</td><td class="grade-cell grade-B">${p('B')}%</td>
        <td class="grade-cell grade-C">${x.C}</td><td class="grade-cell grade-C">${p('C')}%</td>
        <td class="grade-cell grade-D">${x.D}</td><td class="grade-cell grade-D">${p('D')}%</td>
        <td class="grade-cell grade-E">${x.E}</td><td class="grade-cell grade-E">${p('E')}%</td>
        <td class="grade-cell grade-X">${x.X}</td></tr>`;
    });

    html += `<tr class="project-row"><td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${projectTotals.PA}</td><td></td><td>${projectTotals.PB}</td><td></td><td>${projectTotals.PC}</td><td></td>
      <td>${projectTotals.PD}</td><td></td><td>${projectTotals.PE}</td><td></td><td>${projectTotals.PX}</td></tr>`;

    html += `<tfoot><tr><td></td><td><strong>TOTAL (A‚ÄìE)</strong></td><td></td>
      <td>${totals.A}</td><td>${((totals.A/totalSatOverall)*100).toFixed(1)}%</td>
      <td>${totals.B}</td><td>${((totals.B/totalSatOverall)*100).toFixed(1)}%</td>
      <td>${totals.C}</td><td>${((totals.C/totalSatOverall)*100).toFixed(1)}%</td>
      <td>${totals.D}</td><td>${((totals.D/totalSatOverall)*100).toFixed(1)}%</td>
      <td>${totals.E}</td><td>${((totals.E/totalSatOverall)*100).toFixed(1)}%</td><td></td></tr></tfoot></table>`;

    let mean = totalSatOverall ? (totals.A / totalSatOverall * 100) : 0;
    let comment = mean >= 40 ? 'üèÜ Excellent' : (mean >= 25 ? 'üìà Good' : 'üìâ Needs improvement');
    html += `<div class="summary-cards"><div class="card">üéì School %A : ${mean.toFixed(1)}%</div><div class="card">${comment}</div></div>`;
    return html;
  }

  // ========== BUILD GENDER TABLE (with grade colors and section-title) ==========
  function buildGenderTableHTML() {
    let grand = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
    let html = `<h3 class="section-title">‚ö• GENDER DISTRIBUTION BY SUBJECT</h3>`;
    html += `<table><thead><tr><th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th><th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th></tr></thead><tbody>`;

    Object.keys(gender).sort().forEach(s => {
      let g = gender[s];
      Object.keys(grand).forEach(k => grand[k] += g[k] || 0);
      html += `<tr><td style="font-weight:600;">${s}</td>
        <td class="grade-cell grade-A">${g.MA||0}</td>
        <td class="grade-cell grade-B">${g.MB||0}</td>
        <td class="grade-cell grade-C">${g.MC||0}</td>
        <td class="grade-cell grade-D">${g.MD||0}</td>
        <td class="grade-cell grade-E">${g.ME||0}</td>
        <td class="grade-cell grade-A">${g.FA||0}</td>
        <td class="grade-cell grade-B">${g.FB||0}</td>
        <td class="grade-cell grade-C">${g.FC||0}</td>
        <td class="grade-cell grade-D">${g.FD||0}</td>
        <td class="grade-cell grade-E">${g.FE||0}</td>
      </tr>`;
    });

    let totalMale = grand.MA+grand.MB+grand.MC+grand.MD+grand.ME;
    let totalFemale = grand.FA+grand.FB+grand.FC+grand.FD+grand.FE;
    html += `<tfoot><tr style="background:#eef4ff;"><td><strong>TOTAL</strong></td>
      <td>${grand.MA}</td><td>${grand.MB}</td><td>${grand.MC}</td><td>${grand.MD}</td><td>${grand.ME}</td>
      <td>${grand.FA}</td><td>${grand.FB}</td><td>${grand.FC}</td><td>${grand.FD}</td><td>${grand.FE}</td>
    </tr>`;
    html += `<tr style="background:#f0f5fa; font-weight:600;"><td><strong>Male %</strong></td>
      <td>${totalMale?((grand.MA/totalMale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalMale?((grand.MB/totalMale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalMale?((grand.MC/totalMale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalMale?((grand.MD/totalMale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalMale?((grand.ME/totalMale)*100).toFixed(1):'0.0'}%</td>
      <td colspan="5"></td>
    </tr>`;
    html += `<tr style="background:#f0f5fa; font-weight:600;"><td><strong>Female %</strong></td>
      <td colspan="5"></td>
      <td>${totalFemale?((grand.FA/totalFemale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalFemale?((grand.FB/totalFemale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalFemale?((grand.FC/totalFemale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalFemale?((grand.FD/totalFemale)*100).toFixed(1):'0.0'}%</td>
      <td>${totalFemale?((grand.FE/totalFemale)*100).toFixed(1):'0.0'}%</td>
    </tr>`;
    html += `</tfoot></table>`;
    return html;
  }

  // ========== STREAM TABLE (per stream) with PROJECT WORK ==========
  function buildStreamTableHTML(stream) {
    let data = streamData[stream];
    if (!data) return '';
    let subjectsInStream = data.subjects;
    let totals = { A:0, B:0, C:0, D:0, E:0 };
    let totalSat = data.overall.sat;

    let html = `<h3 class="stream-title">üìå Summary of Grade in Stream (${stream})</h3>`;
    html += `<table><thead><tr><th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th><th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th></tr></thead><tbody>`;

    let sorted = Object.keys(subjectsInStream).sort((a,b) => (subjectsInStream[b].A/subjectsInStream[b].sat) - (subjectsInStream[a].A/subjectsInStream[a].sat));
    sorted.forEach((s, i) => {
      let x = subjectsInStream[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      let p = (grade) => x.sat ? ((x[grade] / x.sat) * 100).toFixed(1) : '0.0';
      html += `<tr><td>${i+1}</td><td style="font-weight:600;">${s}</td><td>${x.sat}</td>
        <td class="grade-cell grade-A">${x.A}</td><td class="grade-cell grade-A">${p('A')}%</td>
        <td class="grade-cell grade-B">${x.B}</td><td class="grade-cell grade-B">${p('B')}%</td>
        <td class="grade-cell grade-C">${x.C}</td><td class="grade-cell grade-C">${p('C')}%</td>
        <td class="grade-cell grade-D">${x.D}</td><td class="grade-cell grade-D">${p('D')}%</td>
        <td class="grade-cell grade-E">${x.E}</td><td class="grade-cell grade-E">${p('E')}%</td>
        <td class="grade-cell grade-X">${x.X}</td></tr>`;
    });

    // Add project work row for this stream
    let proj = streamProjectTotals[stream] || { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
    html += `<tr class="project-row"><td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${proj.PA}</td><td></td><td>${proj.PB}</td><td></td><td>${proj.PC}</td><td></td>
      <td>${proj.PD}</td><td></td><td>${proj.PE}</td><td></td><td>${proj.PX}</td></tr>`;

    html += `<tfoot><tr><td></td><td><strong>STREAM TOTAL (A‚ÄìE)</strong></td><td></td>
      <td>${totals.A}</td><td>${((totals.A/totalSat)*100).toFixed(1)}%</td>
      <td>${totals.B}</td><td>${((totals.B/totalSat)*100).toFixed(1)}%</td>
      <td>${totals.C}</td><td>${((totals.C/totalSat)*100).toFixed(1)}%</td>
      <td>${totals.D}</td><td>${((totals.D/totalSat)*100).toFixed(1)}%</td>
      <td>${totals.E}</td><td>${((totals.E/totalSat)*100).toFixed(1)}%</td><td></td></tr></tfoot></table>`;

    let streamPercentA = totalSat ? (totals.A / totalSat * 100).toFixed(1) : 0;
    html += `<div class="summary-cards"><div class="card">üéØ Stream ${stream} %A : ${streamPercentA}%</div></div>`;
    return html;
  }

  // ========== BEST STREAM TABLE (with all grades and percentages) ==========
  function buildBestStreamTableHTML() {
    let streams = Object.keys(streamData);
    if (streams.length === 0) return '';
    let streamPerf = streams.map(s => {
      let o = streamData[s].overall;
      return {
        stream: s,
        sat: o.sat,
        A: o.A, B: o.B, C: o.C, D: o.D, E: o.E, X: o.X,
        pA: o.sat ? (o.A / o.sat * 100).toFixed(1) : 0,
        pB: o.sat ? (o.B / o.sat * 100).toFixed(1) : 0,
        pC: o.sat ? (o.C / o.sat * 100).toFixed(1) : 0,
        pD: o.sat ? (o.D / o.sat * 100).toFixed(1) : 0,
        pE: o.sat ? (o.E / o.sat * 100).toFixed(1) : 0,
        pX: o.sat ? (o.X / o.sat * 100).toFixed(1) : 0
      };
    }).sort((a,b) => b.pA - a.pA);

    let html = `<h3 class="section-title">üèÜ BEST STREAM RANKING (by %A) ‚Äì FULL GRADE DISTRIBUTION</h3>`;
    html += `<table><thead><tr><th>Rank</th><th>Stream</th><th>Entries</th>
      <th>A</th><th>%A</th><th>B</th><th>%B</th><th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th><th>%X</th></tr></thead><tbody>`;

    streamPerf.forEach((p, idx) => {
      html += `<tr><td>${idx+1}</td><td><strong>${p.stream}</strong></td><td>${p.sat}</td>
        <td class="grade-cell grade-A">${p.A}</td><td class="grade-cell grade-A">${p.pA}%</td>
        <td class="grade-cell grade-B">${p.B}</td><td class="grade-cell grade-B">${p.pB}%</td>
        <td class="grade-cell grade-C">${p.C}</td><td class="grade-cell grade-C">${p.pC}%</td>
        <td class="grade-cell grade-D">${p.D}</td><td class="grade-cell grade-D">${p.pD}%</td>
        <td class="grade-cell grade-E">${p.E}</td><td class="grade-cell grade-E">${p.pE}%</td>
        <td class="grade-cell grade-X">${p.X}</td><td class="grade-cell grade-X">${p.pX}%</td></tr>`;
    });

    // Grand total row (all streams combined)
    let grandTotal = streamPerf.reduce((acc, p) => {
      acc.sat += p.sat; acc.A += p.A; acc.B += p.B; acc.C += p.C; acc.D += p.D; acc.E += p.E; acc.X += p.X;
      return acc;
    }, { sat:0, A:0, B:0, C:0, D:0, E:0, X:0 });

    html += `<tfoot><tr><td colspan="2"><strong>ALL STREAMS</strong></td><td>${grandTotal.sat}</td>
      <td>${grandTotal.A}</td><td>${((grandTotal.A/grandTotal.sat)*100).toFixed(1)}%</td>
      <td>${grandTotal.B}</td><td>${((grandTotal.B/grandTotal.sat)*100).toFixed(1)}%</td>
      <td>${grandTotal.C}</td><td>${((grandTotal.C/grandTotal.sat)*100).toFixed(1)}%</td>
      <td>${grandTotal.D}</td><td>${((grandTotal.D/grandTotal.sat)*100).toFixed(1)}%</td>
      <td>${grandTotal.E}</td><td>${((grandTotal.E/grandTotal.sat)*100).toFixed(1)}%</td>
      <td>${grandTotal.X}</td><td>${((grandTotal.X/grandTotal.sat)*100).toFixed(1)}%</td></tr></tfoot></table>`;

    // Top stream card
    let top = streamPerf[0];
    html += `<div class="summary-cards"><div class="card">ü•á Best Stream: ${top.stream} (${top.pA}% A) ¬∑ Total entries: ${top.sat}</div></div>`;
    return html;
  }

  // ========== TOP 20 STUDENTS RANKING TABLE (with separate grade columns) ==========
  function buildTop20TableHTML() {
    if (studentRankings.length === 0) return '';

    let html = `<h3 class="section-title">üèÖ TOP 20 STUDENTS OVERALL RANKING</h3>`;
    html += `<table>
      <thead>
        <tr>
          <th>S/No</th><th>Position</th><th>Index No</th><th>Name</th><th>Sex</th>
          <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>X</th>
          <th>Subjects & Grades</th>
        </tr>
      </thead>
      <tbody>`;

    const top20 = studentRankings.slice(0, 20);
    top20.forEach((student, idx) => {
      let position = idx + 1;
      let posText = position + (position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th');
      let counts = student.gradeCounts;
      
      html += `<tr>
        <td>${idx + 1}</td>
        <td><strong>${posText}</strong></td>
        <td>${student.indexNo}</td>
        <td style="text-align:left;">${student.name}</td>
        <td>${student.sex}</td>
        <td class="grade-cell grade-A">${counts.A}</td>
        <td class="grade-cell grade-B">${counts.B}</td>
        <td class="grade-cell grade-C">${counts.C}</td>
        <td class="grade-cell grade-D">${counts.D}</td>
        <td class="grade-cell grade-E">${counts.E}</td>
        <td class="grade-cell grade-X">${counts.X}</td>
        <td style="text-align:left; font-size:11.5px;">${student.subjects}</td>  <!-- Increased to 11.5px -->
      </tr>`;
    });

    html += `</tbody></table>`;

    // Top performer card
    if (top20.length > 0) {
      let top = top20[0];
      html += `<div class="summary-cards"><div class="card">ü•á Top Student: ${top.name} (${top.indexNo}) ¬∑ A:${top.gradeCounts.A} B:${top.gradeCounts.B} C:${top.gradeCounts.C}</div></div>`;
    }

    return html;
  }

  // ========== RENDER ALL PAGES ==========
  function renderReportPages() {
    let html = `<div class="print-page">${buildSubjectTableHTML()}${buildSignatureBlock()}</div>`;
    html += `<div class="print-page">${buildGenderTableHTML()}${buildSignatureBlock()}</div>`;

    // stream tables (only if streamData has keys)
    Object.keys(streamData).sort().forEach(stream => {
      html += `<div class="print-page">${buildStreamTableHTML(stream)}${buildSignatureBlock()}</div>`;
    });

    // best stream table
    if (Object.keys(streamData).length > 0) {
      html += `<div class="print-page">${buildBestStreamTableHTML()}${buildSignatureBlock()}</div>`;
    }

    // top 20 students table
    if (studentRankings.length > 0) {
      html += `<div class="print-page">${buildTop20TableHTML()}${buildSignatureBlock()}</div>`;
    }

    document.getElementById('reportArea').innerHTML = html;
  }

  // ========== BUILD SIGNATURE BLOCK ‚Äì DYNAMIC FROM SETTINGS ==========
  function buildSignatureBlock() {
    const signatoryName = document.getElementById('signatoryName').value || 'MAWERERE FRANCIS';
    const signatoryTitle = document.getElementById('signatoryTitle').value || 'Data In charge';
    const signatoryPhone = document.getElementById('signatoryPhone').value || '0788222315';
    const signatoryEmail = document.getElementById('signatoryEmail').value || 'mawererefrancis@gmail.com';
    const signatureLabel = document.getElementById('signatureLabel').value || 'Signature:';
    const extraInfo = document.getElementById('extraSignatureInfo').value;

    let extraHtml = extraInfo ? `<div class="signature-line">${extraInfo}</div>` : '';

    return `<div class="signature-block">
      <div class="signature-left">
        <div class="signature-line"><span style="font-weight:700;">${signatureLabel}</span> ___________________________________</div>
        <div class="signature-line"><strong>${signatoryName}</strong> ¬∑ ${signatoryTitle}</div>
        ${extraHtml}
      </div>
      <div class="signature-right">
        <div>üìû ${signatoryPhone}</div>
        <div>‚úâÔ∏è ${signatoryEmail}</div>
      </div>
    </div>`;
  }

  // ========== PRINT ==========
  function printReport() { window.print(); }

  // ========== PDF EXPORT ‚Äì PERFECT FIT, HIGH RES ==========
  function downloadPDF() {
    const element = document.getElementById('reportArea');
    element.classList.add('pdf-export-mode');
    
    // Temporarily adjust styles for PDF generation to ensure perfect fit
    const printPages = document.querySelectorAll('.print-page');
    printPages.forEach(page => {
      page.style.padding = '1.5mm 3mm';
      page.style.margin = '0';
    });

    html2pdf().set({
      margin: [5, 5, 5, 5],
      filename: 'UNEB_ANALYSIS.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 1.2,
        letterRendering: true,
        useCORS: true,
        logging: false,
        dpi: 300,
        windowWidth: 1200,
        onclone: (clonedDoc) => {
          const pages = clonedDoc.querySelectorAll('.print-page');
          pages.forEach(p => {
            p.style.padding = '1.5mm 3mm';
            p.style.boxSizing = 'border-box';
          });
        }
      },
      jsPDF: {
        unit: 'mm',
        format: 'a4',
        orientation: 'landscape'
      }
    }).from(element).save().then(() => {
      printPages.forEach(page => {
        page.style.padding = '';
        page.style.margin = '';
      });
      element.classList.remove('pdf-export-mode');
    });
  }

  // ========== EXCEL EXPORT ‚Äì ONE SHEET PER TABLE ==========
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const tables = document.querySelectorAll('#reportArea .print-page');
    tables.forEach((page, idx) => {
      const h3 = page.querySelector('h3');
      let sheetName = `Sheet${idx+1}`;
      if (h3) {
        let text = h3.innerText;
        if (text.includes('SUBJECT PERFORMANCE')) sheetName = 'Subject Summary';
        else if (text.includes('GENDER DISTRIBUTION')) sheetName = 'Gender Summary';
        else if (text.includes('Summary of Grade in Stream')) {
          let match = text.match(/\(([^)]+)\)/);
          sheetName = match ? match[1].substring(0,20) : 'Stream';
        }
        else if (text.includes('BEST STREAM')) sheetName = 'Best Stream';
        else if (text.includes('TOP 20 STUDENTS')) sheetName = 'Top 20 Students';
        else sheetName = text.substring(0,20).replace(/[^\w]/g,'_');
      }
      const tbl = page.querySelector('table');
      if (tbl) {
        let ws = XLSX.utils.table_to_sheet(tbl);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      }
    });
    const school = document.getElementById('schoolName').value || 'SCHOOL';
    XLSX.writeFile(wb, `UNEB_${school.replace(/\s/g,'_')}_full.xlsx`);
  }

  // ========== GLOBAL ACCESS ==========
  window.logout = logout;
</script>
</body>
</html>
