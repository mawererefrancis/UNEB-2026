<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>UNEB Analytics ¬∑ Mawerere Francis</title>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* -------------------------------
       RESET & GLOBAL ‚Äì professional
    ------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(145deg, #f6f8fc 0%, #edf0f5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #0a1e3c;
    }

    /* ---------- LOGIN PAGE ‚Äì perfect centering (mobile/desktop) ---------- */
    #loginBox {
      background: white;
      width: 90%;
      max-width: 380px;
      margin: auto;
      padding: 2.2rem 1.8rem;
      border-radius: 32px;
      box-shadow: 0 20px 40px -12px rgba(0,20,50,0.25);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
      transition: all 0.2s;
    }

    #loginBox h2 {
      font-weight: 600;
      font-size: 1.9rem;
      margin-bottom: 1.5rem;
      color: #0b2d5c;
      letter-spacing: -0.01em;
      border-bottom: 3px solid #2d68c4;
      display: inline-block;
      padding-bottom: 6px;
    }

    #loginBox input {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      border: 1px solid #cbd5e1;
      border-radius: 60px;
      font-size: 1rem;
      background: #f8fafc;
      transition: 0.2s;
    }

    #loginBox input:focus {
      border-color: #1e3a8a;
      outline: none;
      box-shadow: 0 0 0 4px rgba(30,58,138,0.1);
      background: white;
    }

    #loginBox button {
      background: #0a2c4e;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.3px;
    }

    #loginBox button:hover {
      background: #143b6b;
      transform: scale(0.98);
      box-shadow: 0 8px 16px rgba(0,40,80,0.2);
    }

    #loginError {
      margin-top: 14px;
      font-weight: 500;
      color: #b91c1c;
    }

    /* ---------- MAIN APPLICATION (initially hidden) ---------- */
    #app {
      display: none;
      width: 100%;
      max-width: 1480px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    /* ----- header & school identity ‚Äì elegant alignment ----- */
    .school-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      background: white;
      padding: 18px 28px;
      border-radius: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 18px -8px rgba(0,20,40,0.12);
      border-left: 8px solid #2563eb;
    }

    .school-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #0b2b5e;
      line-height: 1.2;
    }

    .exam-year {
      font-size: 1.4rem;
      font-weight: 600;
      color: #2563eb;
      background: #e6f0ff;
      padding: 6px 18px;
      border-radius: 60px;
      letter-spacing: 1px;
    }

    .uneb-subhead {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 500;
      color: #334155;
      margin-top: 4px;
      width: 100%;
    }

    /* ----- controls panel (clean, modern) ----- */
    .action-bar {
      background: white;
      padding: 16px 24px;
      border-radius: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .action-bar input, .action-bar button {
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid #dbe0e8;
      font-size: 0.95rem;
    }

    .action-bar input {
      background: #f9fcff;
      flex: 1 1 160px;
    }

    .action-bar button {
      background: #1e3a8a;
      color: white;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s;
      box-shadow: 0 4px 6px rgba(0,50,100,0.1);
    }

    .action-bar button:hover {
      background: #15306b;
      transform: translateY(-2px);
    }

    /* ----- report container ‚Äì print-optimized later ----- */
    .report-box {
      background: white;
      border-radius: 28px;
      padding: 28px 22px;
      box-shadow: 0 20px 30px -8px rgba(0,20,50,0.15);
      margin-top: 8px;
      transition: 0.2s;
    }

    /* ----- TABLES ‚Äì compact, readable, professional ----- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5px;
      margin: 18px 0;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    th {
      background: #0a2c4e;
      color: white;
      font-weight: 600;
      padding: 10px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10.5px;
      white-space: nowrap;
    }

    td {
      padding: 7px 4px;
      border-bottom: 1px solid #e6edf4;
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tfoot td {
      background: #eef4ff;
      font-weight: 700;
      color: #0a2c4e;
      border-top: 2px solid #9ab3d8;
    }

    /* highlight project & total rows */
    .project-row, tr[style*="background: #e0f2fe"] {
      background: #e6f0ff !important;
      font-weight: 600;
    }

    /* ----- summary cards ----- */
    .summary-cards {
      display: flex;
      gap: 24px;
      justify-content: flex-start;
      margin: 16px 0 10px;
    }

    .card {
      background: linear-gradient(135deg, #eef4ff, #e6f0fc);
      padding: 14px 28px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      color: #0a2c4e;
      border: 1px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

    /* ----- SIGNATURE ‚Äì bottom left, elegant ----- */
    .signature {
      margin-top: 36px;
      font-size: 13px;
      color: #1e3a5f;
      border-top: 2px dashed #9bb0cc;
      padding-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
    }

    .signature-line {
      font-size: 14px;
      font-weight: 500;
    }

    .signature strong {
      color: #0a2c4e;
    }

    .signature-contact {
      color: #2c4e6b;
    }

    /* ============ SMALL SCREEN OPTIMIZATION ============ */
    @media (max-width: 700px) {
      #app { padding: 12px; }
      .school-header { flex-direction: column; align-items: center; text-align: center; gap: 8px; }
      .exam-year { align-self: center; }
      .action-bar { flex-direction: column; }
      .action-bar button { width: 100%; justify-content: center; }
      table { font-size: 10px; }
      th, td { padding: 6px 2px; }
    }

    /* ============ PRINT & PDF LANDSCAPE A4 ‚Äî ONE PAGE, BOTTOM SIGNATURE ============ */
    @media print {
      @page {
        size: A4 landscape;
        margin: 10mm 12mm 8mm 12mm;
      }

      html, body {
        height: 100%;
        background: white;
        margin: 0;
        padding: 0;
      }

      body * {
        visibility: hidden;
      }

      #app, #app * {
        visibility: visible;
      }

      #app {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: block;
        padding: 0;
        margin: 0;
      }

      .report-box {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 0 6px;
        background: white;
        box-shadow: none;
        border-radius: 0;
      }

      /* TABLES EXTRA COMPACT ‚Äì fit all columns */
      table {
        font-size: 7.8pt !important;
        margin: 6px 0;
        box-shadow: none;
      }

      th {
        padding: 4px 2px !important;
        font-size: 7.5pt !important;
        background: #0a2c4e !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      td {
        padding: 4px 2px !important;
      }

      .school-header {
        padding: 10px 16px;
        background: #f0f5fe;
        border-left-width: 6px;
        -webkit-print-color-adjust: exact;
      }

      /* push signature to bottom of page */
      .signature {
        margin-top: auto;
        border-top: 2px solid #3a5e7a;
        padding-top: 12px;
        font-size: 9pt;
      }

      .action-bar, .action-bar *,
      #file, #schoolName, #year, button:not(.print-persist) {
        display: none !important;
      }

      /* keep cards subtle */
      .summary-cards {
        margin: 4px 0 0;
      }

      .card {
        background: #eaf0f9 !important;
        padding: 6px 18px;
        font-size: 9pt;
        -webkit-print-color-adjust: exact;
      }
    }

    /* ---- pdf export helper (mirror print) ---- */
    .pdf-export-mode table {
      font-size: 7.8pt !important;
    }
    .pdf-export-mode .signature {
      margin-top: auto;
    }
    .pdf-export-mode .action-bar {
      display: none !important;
    }

  </style>
</head>
<body>

<!-- ============ LOGIN ‚Äì perfectly centered ============ -->
<div id="loginBox">
  <h2>üìä UNEB</h2>
  <input id="username" placeholder="Username" value="admin">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="login()">üîê Sign in</button>
  <p id="loginError"></p>
  <div style="margin-top: 12px; color: #4a6479; font-size: 0.85rem;">use admin / 1234</div>
</div>

<!-- ============ MAIN APPLICATION ============ -->
<div id="app">

  <!-- dynamic school header (flex layout) -->
  <div id="schoolHeaderContainer" class="school-header">
    <!-- filled by JS -->
  </div>

  <!-- controls panel -->
  <div class="action-bar">
    <input id="schoolName" placeholder="e.g., ST. JOSEPH'S COLLEGE" value="MAWERERE MEMORIAL SCHOOL">
    <input id="year" placeholder="Year" value="2025">
    <input type="file" id="file" accept=".xlsx,.xls,.csv">
    <button onclick="generateReport()"><span>üìÇ</span> GENERATE REPORT</button>
    <button onclick="printReport()"><span>üñ®Ô∏è</span> PRINT</button>
    <button onclick="downloadPDF()"><span>üìÑ</span> EXPORT PDF</button>
    <button onclick="exportExcel()"><span>üìä</span> EXCEL (2 TABLES)</button>
  </div>

  <!-- REPORT AREA ‚Äì all analytics tables & signature -->
  <div id="reportArea" class="report-box">
    <div id="subjectSummary"></div>
    <div id="genderSummary"></div>
    <div id="analytics"></div>

    <!-- SIGNATURE BLOCK ‚Äì bottom left (print flex) -->
    <div class="signature">
      <div class="signature-line">
        <span style="font-weight: 700;">Signature:</span> ___________________________________<br>
        <span style="font-size: 12px; color: #2d4968;">Mawerere Francis ¬∑ In charge Students Data</span>
      </div>
      <div class="signature-contact">
        üìû 0788222315 &nbsp; ‚úâÔ∏è mawererefrancis@gmail.com
      </div>
    </div>
  </div>
</div>

<script>
  // -------------------- GLOBAL DATA STORE (unchanged counting logic) --------------------
  let subjects = {};   // per subject: sat, A,B,C,D,E,X, PA,PB,PC,PD,PE,PX
  let gender = {};    // per subject: MA,MB,MC,MD,ME, FA,FB,FC,FD,FE

  // -------------------- LOGIN (centered, simple) --------------------
  function login() {
    const user = document.getElementById('username').value;
    const pwd = document.getElementById('password').value;
    if (user === 'admin' && pwd === '1234') {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    } else {
      document.getElementById('loginError').innerText = '‚úò Use admin / 1234';
    }
  }

  // -------------------- GENERATE REPORT ‚Äì counting LOGIC untouched --------------------
  function generateReport() {
    const file = document.getElementById('file').files[0];
    if (!file) { alert('Please select the UNEB Excel annex'); return; }

    const reader = new FileReader();
    reader.onload = function (e) {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

      // reset (pure logic, no changes)
      subjects = {};
      gender = {};

      rows.forEach(row => {
        const sex = String(row.Sex || '').toUpperCase().trim();
        const project = String(row['PROJECT WORK'] || 'X').toUpperCase().trim();
        const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();
        if (!achievements) return;

        const validGrades = ['A','B','C','D','E','X'];
        const pg = validGrades.includes(project) ? project : 'X';

        achievements.split(' ').forEach(item => {
          if (!item.includes('-')) return;
          const [subjectRaw, gradeRaw] = item.split('-');
          const subject = subjectRaw.toUpperCase().trim();
          const g = validGrades.includes(gradeRaw) ? gradeRaw : 'X';

          if (!subjects[subject]) {
            subjects[subject] = { sat: 0, A:0, B:0, C:0, D:0, E:0, X:0, PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
          }
          subjects[subject].sat++;
          subjects[subject][g]++;
          subjects[subject]['P' + pg]++;   // per-subject project counting (kept as original)

          if (!gender[subject]) {
            gender[subject] = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
          }
          if (sex === 'M' && g !== 'X') gender[subject]['M' + g]++;
          if (sex === 'F' && g !== 'X') gender[subject]['F' + g]++;
        });
      });

      // ----- build elegant school header (flex, aligned) -----
      const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
      const year = document.getElementById('year').value || '';
      document.getElementById('schoolHeaderContainer').innerHTML = `
        <span class="school-name">${schoolName}</span>
        <span class="exam-year">üìÜ ${year}</span>
        <div class="uneb-subhead">UGANDA NATIONAL EXAMINATIONS BOARD ¬∑ ANALYSIS</div>
      `;

      renderSubjectTable();
      renderGenderTable();
      renderAnalyticsCards();
    };
    reader.readAsArrayBuffer(file);
  }

  // -------------------- SUBJECT TABLE (complete, project row + totals) --------------------
  function renderSubjectTable() {
    let totals = { A:0, B:0, C:0, D:0, E:0 };

    let html = `<h3 style="color:#0a2c4e; border-left: 6px solid #2563eb; padding-left: 12px; margin-top: 8px;">üìã SUBJECT PERFORMANCE SUMMARY</h3>
    <table>
      <thead>
        <tr>
          <th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th>
          <th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th>
        </tr>
      </thead>
      <tbody>`;

    // sort by %A descending (original ranking)
    let sorted = Object.keys(subjects).sort((a, b) => 
      (subjects[b].A / subjects[b].sat) - (subjects[a].A / subjects[a].sat)
    );

    sorted.forEach((s, i) => {
      let x = subjects[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      let p = (grade) => x.sat ? ((x[grade] / x.sat) * 100).toFixed(1) : '0.0';

      html += `<tr>
        <td><strong>${i+1}</strong></td>
        <td style="font-weight: 600;">${s}</td>
        <td>${x.sat}</td>
        <td>${x.A}</td><td>${p('A')}%</td>
        <td>${x.B}</td><td>${p('B')}%</td>
        <td>${x.C}</td><td>${p('C')}%</td>
        <td>${x.D}</td><td>${p('D')}%</td>
        <td>${x.E}</td><td>${p('E')}%</td>
        <td>${x.X}</td>
      </tr>`;
    });

    // ----- PROJECT WORK row (aggregated as per original logic) -----
    let projTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
    Object.values(subjects).forEach(x => {
      projTotals.PA += x.PA; projTotals.PB += x.PB; projTotals.PC += x.PC;
      projTotals.PD += x.PD; projTotals.PE += x.PE; projTotals.PX += x.PX;
    });

    html += `<tr class="project-row" style="background: #e3effa; font-weight: 600;">
      <td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${projTotals.PA}</td><td></td><td>${projTotals.PB}</td><td></td>
      <td>${projTotals.PC}</td><td></td><td>${projTotals.PD}</td><td></td>
      <td>${projTotals.PE}</td><td></td><td>${projTotals.PX}</td>
    </tr>`;

    // ----- TOTAL row (A-E sum) -----
    html += `<tfoot><tr>
      <td></td><td><strong>TOTAL (A‚ÄìE)</strong></td><td></td>
      <td>${totals.A}</td><td></td><td>${totals.B}</td><td></td>
      <td>${totals.C}</td><td></td><td>${totals.D}</td><td></td>
      <td>${totals.E}</td><td></td><td></td>
    </tr></tfoot></table>`;

    document.getElementById('subjectSummary').innerHTML = html;
  }

  // -------------------- GENDER TABLE (full, totals) --------------------
  function renderGenderTable() {
    let grand = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };

    let html = `<h3 style="color:#0a2c4e; border-left: 6px solid #2563eb; padding-left: 12px; margin-top: 28px;">‚ö• GENDER DISTRIBUTION BY SUBJECT</h3>
    <table>
      <thead>
        <tr>
          <th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
          <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
        </tr>
      </thead>
      <tbody>`;

    Object.keys(gender).sort().forEach(s => {
      let g = gender[s];
      Object.keys(grand).forEach(k => grand[k] += g[k] || 0);
      html += `<tr>
        <td style="font-weight: 600;">${s}</td>
        <td>${g.MA || 0}</td><td>${g.MB || 0}</td><td>${g.MC || 0}</td><td>${g.MD || 0}</td><td>${g.ME || 0}</td>
        <td>${g.FA || 0}</td><td>${g.FB || 0}</td><td>${g.FC || 0}</td><td>${g.FD || 0}</td><td>${g.FE || 0}</td>
      </tr>`;
    });

    html += `<tfoot><tr>
      <td><strong>TOTAL</strong></td>
      <td>${grand.MA}</td><td>${grand.MB}</td><td>${grand.MC}</td><td>${grand.MD}</td><td>${grand.ME}</td>
      <td>${grand.FA}</td><td>${grand.FB}</td><td>${grand.FC}</td><td>${grand.FD}</td><td>${grand.FE}</td>
    </tr></tfoot></table>`;

    document.getElementById('genderSummary').innerHTML = html;
  }

  // -------------------- ANALYTICS CARDS (unchanged %A) --------------------
  function renderAnalyticsCards() {
    let totalA = 0, totalSat = 0;
    Object.values(subjects).forEach(x => { totalA += x.A; totalSat += x.sat; });
    let mean = totalSat ? (totalA / totalSat * 100) : 0;
    let comment = mean >= 40 ? 'üèÜ Excellent Performance' : (mean >= 25 ? 'üìà Good Performance' : 'üìâ Needs Improvement');

    document.getElementById('analytics').innerHTML = `
      <div class="summary-cards">
        <div class="card">üéì School %A : ${mean.toFixed(1)}%</div>
        <div class="card">${comment}</div>
      </div>
    `;
  }

  // -------------------- PRINT (fits one page thanks to print styles) --------------------
  function printReport() { window.print(); }

  // -------------------- PDF EXPORT (enforce print-like compact + bottom signature) --------------------
  function downloadPDF() {
    const reportArea = document.getElementById('reportArea');
    // temporarily add class to mimic print compact
    reportArea.classList.add('pdf-export-mode');
    
    html2pdf().set({
      margin: [8, 10, 5, 10], // top, right, bottom, left (mm)
      filename: 'UNEB_ANALYSIS_MAWERERE.pdf',
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 0.58, letterRendering: true, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    }).from(reportArea).save().then(() => {
      reportArea.classList.remove('pdf-export-mode');
    });
  }

  // -------------------- EXCEL with TWO FULL TABLES (subject + gender) --------------------
  function exportExcel() {
    const wb = XLSX.utils.book_new();

    // ----- Subject summary table (full, incl project & total) -----
    const subjectTable = document.querySelector('#subjectSummary table');
    if (subjectTable) {
      const wsSub = XLSX.utils.table_to_sheet(subjectTable);
      // add title line? we can insert school name
      XLSX.utils.sheet_add_aoa(wsSub, [['SUBJECT ACHIEVEMENT SUMMARY']], { origin: 'A1' });
      XLSX.utils.book_append_sheet(wb, wsSub, 'Subject Summary');
    }

    // ----- Gender distribution table -----
    const genderTable = document.querySelector('#genderSummary table');
    if (genderTable) {
      const wsGen = XLSX.utils.table_to_sheet(genderTable);
      XLSX.utils.sheet_add_aoa(wsGen, [['GENDER DISTRIBUTION']], { origin: 'A1' });
      XLSX.utils.book_append_sheet(wb, wsGen, 'Gender Summary');
    }

    // optional ‚Äì add third sheet with school context
    const school = document.getElementById('schoolName').value || 'SCHOOL';
    const year = document.getElementById('year').value || '';
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([[school + ' UNEB REPORT ' + year]]), 'Cover');
    
    XLSX.writeFile(wb, `UNEB_${school.replace(/\s/g,'_')}_${year || 'report'}.xlsx`);
  }

  // -------------------- (optional) file upload hint --------------------
  window.onload = function() {
    // demo: pre-set login fields
  };
</script>

</body>
</html>