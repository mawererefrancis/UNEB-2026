<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>UNEB Analytics ¬∑ Mawerere Francis</title>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    /* ========== RESET & GLOBAL ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(145deg, #f6f8fc 0%, #edf0f5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #0a1e3c;
    }

    /* ========== LOGIN ‚Äì PERFECT CENTERING ========== */
    #loginBox {
      background: white;
      width: 90%;
      max-width: 380px;
      margin: auto;
      padding: 2.2rem 1.8rem;
      border-radius: 32px;
      box-shadow: 0 20px 40px -12px rgba(0,20,50,0.25);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
    }
    #loginBox h2 {
      font-weight: 600;
      font-size: 1.9rem;
      margin-bottom: 1.5rem;
      color: #0b2d5c;
      border-bottom: 3px solid #2d68c4;
      display: inline-block;
      padding-bottom: 6px;
    }
    #loginBox input {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      border: 1px solid #cbd5e1;
      border-radius: 60px;
      font-size: 1rem;
      background: #f8fafc;
      transition: 0.2s;
    }
    #loginBox input:focus {
      border-color: #1e3a8a;
      outline: none;
      box-shadow: 0 0 0 4px rgba(30,58,138,0.1);
      background: white;
    }
    #loginBox button {
      background: #0a2c4e;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.15s;
    }
    #loginBox button:hover {
      background: #143b6b;
      transform: scale(0.98);
      box-shadow: 0 8px 16px rgba(0,40,80,0.2);
    }
    #loginError { margin-top:14px; font-weight:500; color:#b91c1c; }

    /* ========== MAIN APP ========== */
    #app {
      display: none;
      width: 100%;
      max-width: 1480px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    /* ----- school header ----- */
    .school-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      background: white;
      padding: 18px 28px;
      border-radius: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 18px -8px rgba(0,20,40,0.12);
      border-left: 8px solid #2563eb;
    }
    .school-name { font-size:1.8rem; font-weight:700; color:#0b2b5e; line-height:1.2; }
    .exam-year { font-size:1.4rem; font-weight:600; color:#2563eb; background:#e6f0ff; padding:6px 18px; border-radius:60px; }
    .uneb-subhead { text-align:center; font-size:1.2rem; font-weight:500; color:#334155; margin-top:4px; width:100%; }

    /* ----- action bar ----- */
    .action-bar {
      background: white;
      padding: 16px 24px;
      border-radius: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .action-bar input, .action-bar button {
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid #dbe0e8;
      font-size: 0.95rem;
    }
    .action-bar input { background:#f9fcff; flex:1 1 160px; }
    .action-bar button {
      background: #1e3a8a;
      color: white;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s;
      box-shadow: 0 4px 6px rgba(0,50,100,0.1);
    }
    .action-bar button:hover { background:#15306b; transform:translateY(-2px); }
    .logout-btn { background:#6b2e1e !important; }

    /* ----- testimonial settings panel ----- */
    .settings-toggle {
      background: #f0f4fa;
      border-radius: 20px;
      padding: 8px 20px;
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    .settings-panel {
      background: white;
      border-radius: 20px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: none;
      flex-wrap: wrap;
      gap: 20px;
      border: 1px solid #d4e0ec;
      box-shadow: 0 6px 12px rgba(0,0,0,0.02);
    }
    .settings-panel.show { display: flex; }
    .setting-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .setting-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1e3a5f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .setting-group input, .setting-group textarea {
      padding: 10px 14px;
      border-radius: 16px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      width: 100%;
    }
    .setting-group textarea { min-height: 60px; resize: vertical; }

    /* ----- print‚Äëpage containers (for analytics) ----- */
    .print-page {
      background: white;
      padding: 20px 22px;
      border-radius: 24px;
      box-shadow: 0 20px 30px -8px rgba(0,20,50,0.15);
      margin-bottom: 28px;
      display: flex;
      flex-direction: column;
    }

    /* ----- TABLES ‚Äì centered, with lines ----- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
      border: 1px solid #b0c4ce;
    }
    th {
      background: #0a2c4e;
      color: white;
      font-weight: 600;
      padding: 10px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #b0c4ce;
    }
    td {
      padding: 8px 4px;
      border: 1px solid #b0c4ce;
      text-align: center;
      vertical-align: middle;
    }
    tfoot td {
      background: #eef4ff;
      font-weight: 700;
      color: #0a2c4e;
      border: 1px solid #9ab3d8;
    }
    .project-row { background: #e6f0ff !important; font-weight:600; }

    /* ----- signature block (analytics) ----- */
    .signature-block {
      margin-top: 24px;
      border-top: 2px dashed #9bb0cc;
      padding-top: 18px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 12px;
      color: #1e3a5f;
    }
    .signature-line { font-size:13px; font-weight:500; }

    /* ----- summary cards ----- */
    .summary-cards {
      display: flex;
      gap: 24px;
      justify-content: flex-start;
      margin: 8px 0 0;
    }
    .card {
      background: linear-gradient(135deg, #eef4ff, #e6f0fc);
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      color: #0a2c4e;
      border: 1px solid white;
    }

    /* ========== PRINT / PDF ‚Äì A4 LANDSCAPE for analytics ========== */
    @media print {
      @page { size: A4 landscape; margin: 10mm 12mm 8mm 12mm; }
      body, #app, .report-box { background:white; margin:0; padding:0; }
      .print-page { page-break-after: always; box-shadow:none; border-radius:0; padding:5px 10px; margin:0; display:flex; flex-direction:column; min-height:100%; }
      .print-page:last-child { page-break-after: avoid; }
      table { font-size:9pt !important; margin:8px 0; }
      th { padding:5px 2px !important; font-size:8.5pt !important; background:#0a2c4e !important; color:white !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      td { padding:5px 2px !important; }
      .signature-block { margin-top:auto; border-top:1.5px solid #3a5e7a; font-size:9pt; }
      .action-bar, .settings-toggle, .settings-panel, #file, #schoolName, #year, button { display:none !important; }
    }

    /* ========== TESTIMONIAL PAGE ‚Äì PERFECTLY BALANCED A4 PORTRAIT ========== */
    .testimonial-page {
      width: 210mm;
      min-height: 297mm;
      padding: 12mm 15mm 8mm;  /* balanced top/bottom */
      background: white;
      font-family: 'Times New Roman', Times, serif;
      margin: 0 auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      border: none;
      position: relative;
    }

    /* header with logos ‚Äì crisp images */
    .testimonial-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .logo-box {
      width: 90px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafbfd;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
      image-rendering: auto;
    }
    .logo-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .logo-placeholder {
      font-size: 11px;
      color: #5a6b7a;
      text-align: center;
      text-transform: uppercase;
      font-weight: 600;
    }
    .school-info {
      text-align: center;
      flex: 1;
      margin: 0 8px;
    }
    .school-name-large {
      font-size: 22px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #000;
      line-height: 1.2;
    }
    .school-address {
      font-size: 13px;
      font-weight: 500;
    }
    .school-vision, .school-mission, .school-motto {
      font-size: 11px;
      font-style: italic;
    }

    /* date ‚Äì right aligned */
    .testimonial-date {
      text-align: right;
      margin-top: 2px;
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: bold;
    }

    /* main title */
    .testimonial-title {
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      text-decoration: underline;
      margin: 12px 0 12px;
      text-underline-offset: 4px;
    }

    /* candidate details ‚Äì both on same line */
    .candidate-details {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
      margin: 6px 0 4px;
      flex-wrap: nowrap;       /* force one line */
      white-space: nowrap;
    }
    .candidate-details span {
      white-space: nowrap;
    }

    /* LIN row ‚Äì dotted line fills remaining space */
    .lin-row {
      margin: 8px 0 16px;
      font-size: 16px;
      display: flex;
      align-items: baseline;
      width: 100%;
    }
    .lin-label {
      font-weight: bold;
      margin-right: 8px;
      white-space: nowrap;
    }
    .lin-dots {
      flex: 1;
      border-bottom: 2px dotted #000;
      margin-left: 4px;
      height: 1.2em;
    }

    /* subject table ‚Äì clean borders, consistent */
    .subject-table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0 15px;
      border: 2px solid #000;
    }
    .subject-table th {
      background: #e6e6e6;
      color: #000;
      border: 1px solid #000;
      padding: 7px 4px;
      font-weight: bold;
      font-size: 14px;
    }
    .subject-table td {
      border: 1px solid #000;
      padding: 5px 4px;
      font-size: 14px;
    }

    /* result & project row ‚Äì side by side */
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      margin: 5px 0 0;
    }

    /* signature ‚Äì BOTTOM RIGHT, perfectly aligned */
    .signature-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-top: auto;        /* push to bottom */
      padding-top: 20px;
      width: 100%;
    }
    .signature-line-sign {
      border-top: 2px solid #000;
      width: 240px;
      margin-bottom: 6px;
    }
    .signature-name {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .signature-title {
      font-size: 16px;
    }
    .signature-rank {
      font-size: 16px;
    }

    /* ensure no unexpected overflow */
    .testimonial-page > * {
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<!-- ============ LOGIN ‚Äì perfectly centered ============ -->
<div id="loginBox">
  <h2>üìä UNEB</h2>
  <input id="username" placeholder="Username" value="admin">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="login()">üîê Sign in</button>
  <p id="loginError"></p>
  <div style="margin-top: 12px; color: #4a6479; font-size: 0.85rem;">use admin / 1234</div>
</div>

<!-- ============ MAIN APPLICATION ============ -->
<div id="app">

  <div id="schoolHeaderContainer" class="school-header"></div>

  <!-- main action bar -->
  <div class="action-bar">
    <input id="schoolName" placeholder="School name" value="MAWERERE MEMORIAL SCHOOL">
    <input id="year" placeholder="Year" value="2025">
    <input type="file" id="file" accept=".xlsx,.xls,.csv">
    <button onclick="generateReport()"><span>üìÇ</span> GENERATE REPORT</button>
    <button onclick="printReport()"><span>üñ®Ô∏è</span> PRINT</button>
    <button onclick="downloadPDF()"><span>üìÑ</span> EXPORT PDF</button>
    <button onclick="exportExcel()"><span>üìä</span> EXCEL (2 TABLES)</button>
    <button class="logout-btn" onclick="logout()"><span>üö™</span> LOGOUT</button>
  </div>

  <!-- Testimonial settings toggle -->
  <div class="settings-toggle">
    <span style="font-weight:600;">üìú TESTIMONIAL SETTINGS</span>
    <button onclick="toggleSettings()" style="background:#2d5a7a;">‚öôÔ∏è Configure</button>
  </div>

  <!-- Testimonial configuration panel -->
  <div id="testimonialSettings" class="settings-panel">
    <div class="setting-group">
      <label>Left Logo</label>
      <input type="file" id="logoLeft" accept="image/*">
    </div>
    <div class="setting-group">
      <label>Right Logo</label>
      <input type="file" id="logoRight" accept="image/*">
    </div>
    <div class="setting-group">
      <label>School Name</label>
      <input type="text" id="testSchoolName" value="RUBONGI ARMY SECONDARY SCHOOL">
    </div>
    <div class="setting-group">
      <label>P.O.BOX / ADDRESS</label>
      <input type="text" id="schoolAddress" value="P.O.BOX 698 TORORO">
    </div>
    <div class="setting-group">
      <label>Telephone 1</label>
      <input type="text" id="tel1" value="0782651148">
    </div>
    <div class="setting-group">
      <label>Telephone 2</label>
      <input type="text" id="tel2" value="0788222315">
    </div>
    <div class="setting-group">
      <label>Website</label>
      <input type="text" id="website" value="www.rubongiarmy.sc.ug">
    </div>
    <div class="setting-group">
      <label>Vision</label>
      <textarea id="vision">To produce a morally upright and self reliant future generation.</textarea>
    </div>
    <div class="setting-group">
      <label>Mission</label>
      <textarea id="mission">To provide affordable quality education to our community</textarea>
    </div>
    <div class="setting-group">
      <label>Motto</label>
      <textarea id="motto">Discipline, Excellence, Service</textarea>
    </div>
    <div class="setting-group">
      <label>Head Teacher Name</label>
      <input type="text" id="htName" value="ZAINA .K. NALUKENGE">
    </div>
    <div class="setting-group">
      <label>Head Title</label>
      <input type="text" id="htTitle" value="Maj.">
    </div>
    <div class="setting-group">
      <label>Head Rank</label>
      <input type="text" id="htRank" value="HEAD TEACHER">
    </div>
    <div style="flex:1 1 100%; display:flex; justify-content:flex-end;">
      <button onclick="generateTestimonialPDFs()" style="background:#0f5c4b; padding:14px 32px;">
        üì¶ GENERATE TESTIMONIALS (ZIP / PDF)
      </button>
    </div>
  </div>

  <!-- REPORT AREA ‚Äì analytics tables (separate pages) -->
  <div id="reportArea"></div>

</div>

<script>
  // -------------------- GLOBAL DATA (COUNTING LOGIC UNTOUCHED) --------------------
  let subjects = {};   // per subject: sat, A,B,C,D,E,X, PA,PB,PC,PD,PE,PX
  let gender = {};    // per subject: MA,MB,MC,MD,ME, FA,FB,FC,FD,FE
  let lastLoadedRows = null;   // raw rows for testimonial export

  // -------------------- LOGIN / LOGOUT --------------------
  function login() {
    if (username.value === "admin" && password.value === "1234") {
      loginBox.style.display = "none";
      app.style.display = "block";
    } else {
      loginError.innerText = "‚úò Use admin / 1234";
    }
  }
  function logout() {
    app.style.display = "none";
    loginBox.style.display = "block";
    username.value = "admin";
    password.value = "1234";
    loginError.innerText = "";
  }

  // -------------------- TOGGLE TESTIMONIAL SETTINGS --------------------
  function toggleSettings() {
    document.getElementById('testimonialSettings').classList.toggle('show');
  }

  // -------------------- GENERATE REPORT ‚Äì COUNTING LOGIC EXACTLY ORIGINAL --------------------
  function generateReport() {
    const file = document.getElementById('file').files[0];
    if (!file) { alert('Please select the UNEB Excel annex'); return; }

    const reader = new FileReader();
    reader.onload = function (e) {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      lastLoadedRows = rows;   // store for testimonials

      // ----- reset (original logic, unchanged) -----
      subjects = {};
      gender = {};

      rows.forEach(row => {
        const sex = String(row.Sex || '').toUpperCase().trim();
        const project = String(row['PROJECT WORK'] || 'X').toUpperCase().trim();
        const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();
        if (!achievements) return;

        const validGrades = ['A','B','C','D','E','X'];
        const pg = validGrades.includes(project) ? project : 'X';

        achievements.split(' ').forEach(item => {
          if (!item.includes('-')) return;
          const [subjectRaw, gradeRaw] = item.split('-');
          const subject = subjectRaw.toUpperCase().trim();
          const g = validGrades.includes(gradeRaw) ? gradeRaw : 'X';

          if (!subjects[subject]) {
            subjects[subject] = { sat:0, A:0, B:0, C:0, D:0, E:0, X:0, PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
          }
          subjects[subject].sat++;
          subjects[subject][g]++;
          subjects[subject]['P' + pg]++;

          if (!gender[subject]) {
            gender[subject] = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
          }
          if (sex === 'M' && g !== 'X') gender[subject]['M' + g]++;
          if (sex === 'F' && g !== 'X') gender[subject]['F' + g]++;
        });
      });

      // school header
      const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
      const year = document.getElementById('year').value || '';
      document.getElementById('schoolHeaderContainer').innerHTML = `
        <span class="school-name">${schoolName}</span>
        <span class="exam-year">üìÜ ${year}</span>
        <div class="uneb-subhead">UGANDA NATIONAL EXAMINATIONS BOARD ¬∑ ANALYSIS</div>
      `;

      renderReportPages();
    };
    reader.readAsArrayBuffer(file);
  }

  // -------------------- RENDER SUBJECT TABLE (full, with analytics) --------------------
  function buildSubjectTableHTML() {
    let totals = { A:0, B:0, C:0, D:0, E:0 };
    let html = `<h3 style="color:#0a2c4e; border-left:6px solid #2563eb; padding-left:12px; margin-bottom:6px;">üìã TABLE 1: SUBJECT PERFORMANCE SUMMARY</h3>`;
    html += `<table>
      <thead><tr><th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th><th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th></tr></thead><tbody>`;

    let sorted = Object.keys(subjects).sort((a,b) => (subjects[b].A/subjects[b].sat) - (subjects[a].A/subjects[a].sat));
    sorted.forEach((s,i) => {
      let x = subjects[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      let p = gr => x.sat ? ((x[gr]/x.sat)*100).toFixed(1) : '0.0';
      html += `<tr><td><strong>${i+1}</strong></td><td style="font-weight:600;">${s}</td><td>${x.sat}</td>
        <td>${x.A}</td><td>${p('A')}%</td><td>${x.B}</td><td>${p('B')}%</td>
        <td>${x.C}</td><td>${p('C')}%</td><td>${x.D}</td><td>${p('D')}%</td>
        <td>${x.E}</td><td>${p('E')}%</td><td>${x.X}</td></tr>`;
    });

    let projTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
    Object.values(subjects).forEach(x => { projTotals.PA += x.PA; projTotals.PB += x.PB; projTotals.PC += x.PC; projTotals.PD += x.PD; projTotals.PE += x.PE; projTotals.PX += x.PX; });

    html += `<tr class="project-row"><td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${projTotals.PA}</td><td></td><td>${projTotals.PB}</td><td></td>
      <td>${projTotals.PC}</td><td></td><td>${projTotals.PD}</td><td></td>
      <td>${projTotals.PE}</td><td></td><td>${projTotals.PX}</td></tr>`;

    html += `<tfoot><tr><td></td><td><strong>TOTAL (A‚ÄìE)</strong></td><td></td>
      <td>${totals.A}</td><td></td><td>${totals.B}</td><td></td>
      <td>${totals.C}</td><td></td><td>${totals.D}</td><td></td>
      <td>${totals.E}</td><td></td><td></td></tr></tfoot></table>`;

    // analytics cards
    let totalA = 0, totalSat = 0;
    Object.values(subjects).forEach(x => { totalA += x.A; totalSat += x.sat; });
    let mean = totalSat ? (totalA / totalSat * 100) : 0;
    let comment = mean >= 40 ? 'üèÜ Excellent' : (mean >= 25 ? 'üìà Good' : 'üìâ Needs Improvement');
    html += `<div class="summary-cards"><div class="card">üéì School %A : ${mean.toFixed(1)}%</div><div class="card">${comment}</div></div>`;
    return html;
  }

  // -------------------- RENDER GENDER TABLE --------------------
  function buildGenderTableHTML() {
    let grand = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
    let html = `<h3 style="color:#0a2c4e; border-left:6px solid #2563eb; padding-left:12px; margin-bottom:6px;">‚ö• TABLE 2: GENDER DISTRIBUTION BY SUBJECT</h3>`;
    html += `<table><thead><tr><th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th><th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th></tr></thead><tbody>`;

    Object.keys(gender).sort().forEach(s => {
      let g = gender[s];
      Object.keys(grand).forEach(k => grand[k] += g[k] || 0);
      html += `<tr><td style="font-weight:600;">${s}</td><td>${g.MA||0}</td><td>${g.MB||0}</td><td>${g.MC||0}</td><td>${g.MD||0}</td><td>${g.ME||0}</td><td>${g.FA||0}</td><td>${g.FB||0}</td><td>${g.FC||0}</td><td>${g.FD||0}</td><td>${g.FE||0}</td></tr>`;
    });

    html += `<tfoot><tr><td><strong>TOTAL</strong></td><td>${grand.MA}</td><td>${grand.MB}</td><td>${grand.MC}</td><td>${grand.MD}</td><td>${grand.ME}</td><td>${grand.FA}</td><td>${grand.FB}</td><td>${grand.FC}</td><td>${grand.FD}</td><td>${grand.FE}</td></tr></tfoot></table>`;
    return html;
  }

  // -------------------- SIGNATURE BLOCK (for analytics pages) --------------------
  function buildSignatureBlock() {
    return `<div class="signature-block"><div class="signature-line"><span style="font-weight:700;">Signature:</span> ___________________________________<br><span style="font-size:12px; color:#2d4968;">Mawerere Francis ¬∑ In charge Students Data</span></div><div class="signature-contact">üìû 0788222315 &nbsp; ‚úâÔ∏è mawererefrancis@gmail.com</div></div>`;
  }

  // -------------------- RENDER TWO PAGES --------------------
  function renderReportPages() {
    let html = `<div class="print-page">${buildSubjectTableHTML()}${buildSignatureBlock()}</div>`;
    html += `<div class="print-page">${buildGenderTableHTML()}${buildSignatureBlock()}</div>`;
    document.getElementById('reportArea').innerHTML = html;
  }

  // -------------------- PRINT / PDF / EXCEL (unchanged) --------------------
  function printReport() { window.print(); }
  function downloadPDF() {
    const element = document.getElementById('reportArea');
    element.classList.add('pdf-export-mode');
    html2pdf().set({ margin:[8,10,5,10], filename:'UNEB_ANALYSIS_MAWERERE.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:0.58,letterRendering:true,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'landscape'} }).from(element).save().then(() => element.classList.remove('pdf-export-mode'));
  }
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const subjectTable = document.querySelector('#reportArea .print-page:first-child table');
    if (subjectTable) { const ws = XLSX.utils.table_to_sheet(subjectTable); XLSX.utils.sheet_add_aoa(ws, [['SUBJECT ACHIEVEMENT SUMMARY']], { origin:'A1' }); XLSX.utils.book_append_sheet(wb, ws, 'Subject Summary'); }
    const genderTable = document.querySelector('#reportArea .print-page:last-child table');
    if (genderTable) { const ws = XLSX.utils.table_to_sheet(genderTable); XLSX.utils.sheet_add_aoa(ws, [['GENDER DISTRIBUTION']], { origin:'A1' }); XLSX.utils.book_append_sheet(wb, ws, 'Gender Summary'); }
    const school = document.getElementById('schoolName').value || 'SCHOOL'; const year = document.getElementById('year').value || '';
    XLSX.writeFile(wb, `UNEB_${school.replace(/\s/g,'_')}_${year||'report'}.xlsx`);
  }

  // -------------------- INDIVIDUAL TESTIMONIAL ‚Äì PERFECTLY BALANCED A4, CRISP IMAGES --------------------
  async function generateTestimonialPDFs() {
    if (!lastLoadedRows || lastLoadedRows.length === 0) {
      alert('Please generate the report first (upload Excel and click GENERATE REPORT)');
      return;
    }

    // read logo files as dataURLs
    const logoLeftFile = document.getElementById('logoLeft').files[0];
    const logoRightFile = document.getElementById('logoRight').files[0];
    let logoLeftData = null, logoRightData = null;
    if (logoLeftFile) logoLeftData = await readFileAsDataURL(logoLeftFile);
    if (logoRightFile) logoRightData = await readFileAsDataURL(logoRightFile);

    // get all school settings
    const settings = {
      schoolName: document.getElementById('testSchoolName').value || 'RUBONGI ARMY SECONDARY SCHOOL',
      address: document.getElementById('schoolAddress').value || 'P.O.BOX 698 TORORO',
      tel1: document.getElementById('tel1').value || '0782651148',
      tel2: document.getElementById('tel2').value || '0788222315',
      website: document.getElementById('website').value || 'www.rubongiarmy.sc.ug',
      vision: document.getElementById('vision').value || 'To produce a morally upright and self reliant future generation.',
      mission: document.getElementById('mission').value || 'To provide affordable quality education to our community',
      motto: document.getElementById('motto').value || 'Discipline, Excellence, Service',
      htName: document.getElementById('htName').value || 'ZAINA .K. NALUKENGE',
      htTitle: document.getElementById('htTitle').value || 'Maj.',
      htRank: document.getElementById('htRank').value || 'HEAD TEACHER'
    };

    const currentDate = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'numeric' }); // DD/MM/YYYY

    const zip = new JSZip();
    const folder = zip.folder('Testimonials');

    for (const row of lastLoadedRows) {
      const candidateName = row.Candidate_Name || 'Unknown';
      const indexNo = row.IndexNo || '';
      const resultOverall = row.Result || '';
      const projectGrade = row['PROJECT WORK'] || 'X';
      const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();

      // parse subject-grade pairs
      const subjectsList = [];
      if (achievements) {
        achievements.split(' ').forEach(item => {
          if (item.includes('-')) {
            let [sub, grad] = item.split('-');
            subjectsList.push([sub.trim(), grad.trim()]);
          }
        });
      }

      // ----- BUILD PERFECTLY BALANCED TESTIMONIAL HTML -----
      const testimonialHTML = `
        <div class="testimonial-page">
          <!-- Header with logos and school info -->
          <div class="testimonial-header">
            <div class="logo-box">
              ${logoLeftData 
                ? `<img src="${logoLeftData}" alt="School Logo" crossorigin="anonymous">` 
                : `<span class="logo-placeholder">SCHOOL<br>LOGO</span>`}
            </div>
            <div class="school-info">
              <div class="school-name-large">${settings.schoolName}</div>
              <div class="school-address">${settings.address}  TEL: ${settings.tel1} / ${settings.tel2}</div>
              <div class="school-address">${settings.website}</div>
              <div class="school-vision">VISION: <em>${settings.vision}</em></div>
              <div class="school-mission">MISSION: <em>${settings.mission}</em></div>
              <div class="school-motto">MOTTO: <em>${settings.motto}</em></div>
            </div>
            <div class="logo-box">
              ${logoRightData 
                ? `<img src="${logoRightData}" alt="School Logo" crossorigin="anonymous">` 
                : `<span class="logo-placeholder">SCHOOL<br>LOGO</span>`}
            </div>
          </div>

          <!-- Date (right aligned) -->
          <div class="testimonial-date"><strong>DATE:</strong> ${currentDate}</div>

          <!-- Testimonial Title -->
          <div class="testimonial-title">NLSC TESTIMONIAL 2026</div>

          <!-- Candidate details ‚Äì both on ONE line -->
          <div class="candidate-details">
            <span><strong>NAME:</strong> ${candidateName}</span>
            <span><strong>INDEX NO:</strong> ${indexNo}</span>
          </div>

          <!-- LIN row with dotted line (full width) -->
          <div class="lin-row">
            <span class="lin-label"><strong>LIN:</strong></span>
            <span class="lin-dots"></span>
          </div>

          <!-- Subject table ‚Äì even if empty, show placeholder -->
          <table class="subject-table">
            <thead>
              <tr>
                <th>S/NO</th>
                <th>SUBJECT</th>
                <th>SUBJECT ACHIEVEMENT</th>
              </tr>
            </thead>
            <tbody>
              ${subjectsList.length > 0 
                ? subjectsList.map(([sub, grade], idx) => `
                    <tr>
                      <td>${idx + 1}</td>
                      <td>${sub}</td>
                      <td style="font-weight: bold; text-align: center;">${grade}</td>
                    </tr>
                  `).join('')
                : `<tr><td colspan="3" style="text-align:center; font-style:italic;">No subjects recorded</td></tr>`
              }
            </tbody>
          </table>

          <!-- Result and Project Work -->
          <div class="result-row">
            <span><strong>RESULT:</strong> ${resultOverall}</span>
            <span><strong>PROJECT WORK:</strong> ${projectGrade}</span>
          </div>

          <!-- Signature block ‚Äì BOTTOM RIGHT, exactly like Word -->
          <div class="signature-wrapper">
            <div class="signature-line-sign"></div>
            <div class="signature-name">${settings.htName}</div>
            <div class="signature-title">${settings.htTitle}</div>
            <div class="signature-rank">${settings.htRank}</div>
          </div>
        </div>
      `;

      // create a temporary container
      const container = document.createElement('div');
      container.innerHTML = testimonialHTML;
      document.body.appendChild(container);

      // ensure all images are fully loaded
      const images = container.querySelectorAll('img');
      await Promise.all(Array.from(images).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
      }));

      try {
        // HIGH-QUALITY PDF ‚Äì scale 2.8 for razor-sharp logos and text
        const pdfBlob = await html2pdf().set({
          margin: [8, 8, 8, 8],     // even margins
          filename: `${candidateName}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2.8,            // ultra high resolution for print
            letterRendering: true, 
            useCORS: true, 
            logging: false,
            allowTaint: false
          },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(container).output('blob');

        folder.file(`${sanitizeFileName(candidateName)}.pdf`, pdfBlob);
      } catch (err) {
        console.error('PDF generation failed for', candidateName, err);
      }

      document.body.removeChild(container);
    }

    // generate zip
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const zipLink = document.createElement('a');
    zipLink.href = URL.createObjectURL(zipBlob);
    zipLink.download = `Testimonials_${settings.schoolName.replace(/\s/g,'_')}_${new Date().getTime()}.zip`;
    zipLink.click();
  }

  // helper: read file as dataURL
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // sanitize filename
  function sanitizeFileName(name) {
    return name.replace(/[\\/*?:"<>|]/g, '_').trim();
  }

  // expose functions
  window.toggleSettings = toggleSettings;
  window.generateTestimonialPDFs = generateTestimonialPDFs;
  window.logout = logout;
</script>

</body>
</html>
