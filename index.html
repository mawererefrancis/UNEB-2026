<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>UNEB Analytics ¬∑ Mawerere Francis</title>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* -------------------------------
       RESET & GLOBAL ‚Äì professional
    ------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(145deg, #f6f8fc 0%, #edf0f5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #0a1e3c;
    }

    /* ---------- LOGIN PAGE ‚Äì perfect centering (mobile/desktop) ---------- */
    #loginBox {
      background: white;
      width: 90%;
      max-width: 380px;
      margin: auto;
      padding: 2.2rem 1.8rem;
      border-radius: 32px;
      box-shadow: 0 20px 40px -12px rgba(0,20,50,0.25);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
    }

    #loginBox h2 {
      font-weight: 600;
      font-size: 1.9rem;
      margin-bottom: 1.5rem;
      color: #0b2d5c;
      border-bottom: 3px solid #2d68c4;
      display: inline-block;
      padding-bottom: 6px;
    }

    #loginBox input {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      border: 1px solid #cbd5e1;
      border-radius: 60px;
      font-size: 1rem;
      background: #f8fafc;
      transition: 0.2s;
    }

    #loginBox input:focus {
      border-color: #1e3a8a;
      outline: none;
      box-shadow: 0 0 0 4px rgba(30,58,138,0.1);
      background: white;
    }

    #loginBox button {
      background: #0a2c4e;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.15s;
    }

    #loginBox button:hover {
      background: #143b6b;
      transform: scale(0.98);
      box-shadow: 0 8px 16px rgba(0,40,80,0.2);
    }

    #loginError {
      margin-top: 14px;
      font-weight: 500;
      color: #b91c1c;
    }

    /* ---------- MAIN APPLICATION ---------- */
    #app {
      display: none;
      width: 100%;
      max-width: 1480px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    /* ----- school header ‚Äì elegant alignment ----- */
    .school-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      background: white;
      padding: 18px 28px;
      border-radius: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 18px -8px rgba(0,20,40,0.12);
      border-left: 8px solid #2563eb;
    }

    .school-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #0b2b5e;
      line-height: 1.2;
    }

    .exam-year {
      font-size: 1.4rem;
      font-weight: 600;
      color: #2563eb;
      background: #e6f0ff;
      padding: 6px 18px;
      border-radius: 60px;
    }

    .uneb-subhead {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 500;
      color: #334155;
      margin-top: 4px;
      width: 100%;
    }

    /* ----- controls panel ----- */
    .action-bar {
      background: white;
      padding: 16px 24px;
      border-radius: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .action-bar input, .action-bar button {
      padding: 12px 20px;
      border-radius: 40px;
      border: 1px solid #dbe0e8;
      font-size: 0.95rem;
    }

    .action-bar input {
      background: #f9fcff;
      flex: 1 1 160px;
    }

    .action-bar button {
      background: #1e3a8a;
      color: white;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s;
      box-shadow: 0 4px 6px rgba(0,50,100,0.1);
    }

    .action-bar button:hover {
      background: #15306b;
      transform: translateY(-2px);
    }

    /* ----- print‚Äëpage containers (force separate pages) ----- */
    .print-page {
      background: white;
      padding: 20px 22px;
      border-radius: 24px;
      box-shadow: 0 20px 30px -8px rgba(0,20,50,0.15);
      margin-bottom: 28px;
      display: flex;
      flex-direction: column;
    }

    /* ----- TABLES ‚Äì centered, improved font size ----- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;          /* slightly larger for screen */
      margin: 16px 0;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    th {
      background: #0a2c4e;
      color: white;
      font-weight: 600;
      padding: 10px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      text-align: center;
      vertical-align: middle;
    }

    td {
      padding: 8px 4px;
      border-bottom: 1px solid #e6edf4;
      text-align: center;
      vertical-align: middle;
    }

    tfoot td {
      background: #eef4ff;
      font-weight: 700;
      color: #0a2c4e;
      border-top: 2px solid #9ab3d8;
    }

    .project-row {
      background: #e6f0ff !important;
      font-weight: 600;
    }

    /* ----- signature block (appears on every printed page) ----- */
    .signature-block {
      margin-top: 24px;
      border-top: 2px dashed #9bb0cc;
      padding-top: 18px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 12px;
      color: #1e3a5f;
    }

    .signature-line {
      font-size: 13px;
      font-weight: 500;
    }

    .signature-contact {
      color: #2c4e6b;
    }

    /* ----- summary cards ----- */
    .summary-cards {
      display: flex;
      gap: 24px;
      justify-content: flex-start;
      margin: 8px 0 0;
    }

    .card {
      background: linear-gradient(135deg, #eef4ff, #e6f0fc);
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      color: #0a2c4e;
      border: 1px solid white;
    }

    /* ----- mobile responsive ----- */
    @media (max-width: 700px) {
      #app { padding: 12px; }
      .school-header { flex-direction: column; align-items: center; text-align: center; }
      .action-bar { flex-direction: column; }
      .action-bar button { width: 100%; justify-content: center; }
      table { font-size: 11px; }
    }

    /* ============ PRINT / PDF ‚Äì A4 LANDSCAPE, PAGE BREAKS, OWN SIGNATURE ============ */
    @media print {
      @page {
        size: A4 landscape;
        margin: 10mm 12mm 8mm 12mm;
      }

      body, #app, .report-box {
        background: white;
        margin: 0;
        padding: 0;
      }

      .print-page {
        page-break-after: always;    /* each page forces a break */
        box-shadow: none;
        border-radius: 0;
        padding: 5px 10px;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100%;           /* pushes signature to bottom */
      }

      .print-page:last-child {
        page-break-after: avoid;    /* no extra blank page */
      }

      table {
        font-size: 9pt !important;
        margin: 8px 0;
        box-shadow: none;
      }

      th {
        padding: 5px 2px !important;
        font-size: 8.5pt !important;
        background: #0a2c4e !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      td {
        padding: 5px 2px !important;
      }

      .school-header {
        padding: 8px 12px;
        -webkit-print-color-adjust: exact;
      }

      .signature-block {
        margin-top: auto;           /* stick to bottom */
        border-top: 1.5px solid #3a5e7a;
        font-size: 9pt;
      }

      .action-bar, #file, #schoolName, #year, button:not(.print-persist) {
        display: none !important;
      }

      .card {
        background: #eaf0f9 !important;
        -webkit-print-color-adjust: exact;
      }
    }

    /* helper for PDF export */
    .pdf-export-mode .print-page {
      page-break-after: always;
    }
  </style>
</head>
<body>

<!-- ============ LOGIN ‚Äì perfectly centered ============ -->
<div id="loginBox">
  <h2>üìä UNEB</h2>
  <input id="username" placeholder="Username" value="admin">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="login()">üîê Sign in</button>
  <p id="loginError"></p>
  <div style="margin-top: 12px; color: #4a6479; font-size: 0.85rem;">use admin / 1234</div>
</div>

<!-- ============ MAIN APPLICATION ============ -->
<div id="app">

  <div id="schoolHeaderContainer" class="school-header">
    <!-- filled by JS -->
  </div>

  <div class="action-bar">
    <input id="schoolName" placeholder="School name" value="MAWERERE MEMORIAL SCHOOL">
    <input id="year" placeholder="Year" value="2025">
    <input type="file" id="file" accept=".xlsx,.xls,.csv">
    <button onclick="generateReport()"><span>üìÇ</span> GENERATE REPORT</button>
    <button onclick="printReport()"><span>üñ®Ô∏è</span> PRINT</button>
    <button onclick="downloadPDF()"><span>üìÑ</span> EXPORT PDF</button>
    <button onclick="exportExcel()"><span>üìä</span> EXCEL (2 TABLES)</button>
    <button onclick="generateTestimonials()" style="background: #0f5c4b;"><span>üìú</span> TESTIMONIALS (Excel)</button>
  </div>

  <!-- REPORT AREA ‚Äì now contains separate .print-page containers -->
  <div id="reportArea"></div>

</div>

<script>
  // -------------------- GLOBAL DATA STORE (COUNTING LOGIC UNCHANGED) --------------------
  let subjects = {};   // per subject: sat, A,B,C,D,E,X, PA,PB,PC,PD,PE,PX
  let gender = {};    // per subject: MA,MB,MC,MD,ME, FA,FB,FC,FD,FE
  let lastLoadedRows = null;   // store rows for testimonial generation

  // -------------------- LOGIN --------------------
  function login() {
    const user = document.getElementById('username').value;
    const pwd = document.getElementById('password').value;
    if (user === 'admin' && pwd === '1234') {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    } else {
      document.getElementById('loginError').innerText = '‚úò Use admin / 1234';
    }
  }

  // -------------------- GENERATE REPORT (counting logic exactly as original) --------------------
  function generateReport() {
    const file = document.getElementById('file').files[0];
    if (!file) { alert('Please select the UNEB Excel annex'); return; }

    const reader = new FileReader();
    reader.onload = function (e) {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      lastLoadedRows = rows;   // keep for testimonial export

      // reset (pure original logic)
      subjects = {};
      gender = {};

      rows.forEach(row => {
        const sex = String(row.Sex || '').toUpperCase().trim();
        const project = String(row['PROJECT WORK'] || 'X').toUpperCase().trim();
        const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();
        if (!achievements) return;

        const validGrades = ['A','B','C','D','E','X'];
        const pg = validGrades.includes(project) ? project : 'X';

        achievements.split(' ').forEach(item => {
          if (!item.includes('-')) return;
          const [subjectRaw, gradeRaw] = item.split('-');
          const subject = subjectRaw.toUpperCase().trim();
          const g = validGrades.includes(gradeRaw) ? gradeRaw : 'X';

          if (!subjects[subject]) {
            subjects[subject] = { sat:0, A:0, B:0, C:0, D:0, E:0, X:0, PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
          }
          subjects[subject].sat++;
          subjects[subject][g]++;
          subjects[subject]['P' + pg]++;

          if (!gender[subject]) {
            gender[subject] = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };
          }
          if (sex === 'M' && g !== 'X') gender[subject]['M' + g]++;
          if (sex === 'F' && g !== 'X') gender[subject]['F' + g]++;
        });
      });

      // build school header
      const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
      const year = document.getElementById('year').value || '';
      document.getElementById('schoolHeaderContainer').innerHTML = `
        <span class="school-name">${schoolName}</span>
        <span class="exam-year">üìÜ ${year}</span>
        <div class="uneb-subhead">UGANDA NATIONAL EXAMINATIONS BOARD ¬∑ ANALYSIS</div>
      `;

      renderReportPages();  // creates two separate .print-page containers
    };
    reader.readAsArrayBuffer(file);
  }

  // -------------------- RENDER BOTH TABLES AS SEPARATE PAGES WITH SIGNATURE --------------------
  function renderReportPages() {
    let html = '';

    // ---------- PAGE 1 : SUBJECT SUMMARY ----------
    html += `<div class="print-page">`;
    html += buildSubjectTableHTML();   // full table with title, project row, totals
    html += buildSignatureBlock();     // signature for page 1
    html += `</div>`;

    // ---------- PAGE 2 : GENDER SUMMARY ----------
    html += `<div class="print-page">`;
    html += buildGenderTableHTML();
    html += buildSignatureBlock();
    html += `</div>`;

    // optional: analytics cards only on first page? put inside subject page
    // but we already have subject table; we can embed cards below the table.
    // We'll adjust buildSubjectTableHTML to include analytics cards after the table.
    document.getElementById('reportArea').innerHTML = html;
  }

  // -------------------- BUILD SUBJECT TABLE (with title and cards) --------------------
  function buildSubjectTableHTML() {
    let totals = { A:0, B:0, C:0, D:0, E:0 };

    let html = `<h3 style="color:#0a2c4e; border-left: 6px solid #2563eb; padding-left: 12px; margin-bottom: 6px;">üìã TABLE 1: SUBJECT PERFORMANCE SUMMARY</h3>`;

    html += `<table>
      <thead>
        <tr>
          <th>Rank</th><th>Subject</th><th>Sat</th><th>A</th><th>%A</th><th>B</th><th>%B</th>
          <th>C</th><th>%C</th><th>D</th><th>%D</th><th>E</th><th>%E</th><th>X</th>
        </tr>
      </thead>
      <tbody>`;

    let sorted = Object.keys(subjects).sort((a, b) => 
      (subjects[b].A / subjects[b].sat) - (subjects[a].A / subjects[a].sat)
    );

    sorted.forEach((s, i) => {
      let x = subjects[s];
      totals.A += x.A; totals.B += x.B; totals.C += x.C; totals.D += x.D; totals.E += x.E;
      let p = (grade) => x.sat ? ((x[grade] / x.sat) * 100).toFixed(1) : '0.0';

      html += `<tr>
        <td><strong>${i+1}</strong></td>
        <td style="font-weight: 600;">${s}</td>
        <td>${x.sat}</td>
        <td>${x.A}</td><td>${p('A')}%</td>
        <td>${x.B}</td><td>${p('B')}%</td>
        <td>${x.C}</td><td>${p('C')}%</td>
        <td>${x.D}</td><td>${p('D')}%</td>
        <td>${x.E}</td><td>${p('E')}%</td>
        <td>${x.X}</td>
      </tr>`;
    });

    // project row
    let projTotals = { PA:0, PB:0, PC:0, PD:0, PE:0, PX:0 };
    Object.values(subjects).forEach(x => {
      projTotals.PA += x.PA; projTotals.PB += x.PB; projTotals.PC += x.PC;
      projTotals.PD += x.PD; projTotals.PE += x.PE; projTotals.PX += x.PX;
    });

    html += `<tr class="project-row" style="background: #e3effa; font-weight: 600;">
      <td></td><td>üìå PROJECT WORK</td><td></td>
      <td>${projTotals.PA}</td><td></td><td>${projTotals.PB}</td><td></td>
      <td>${projTotals.PC}</td><td></td><td>${projTotals.PD}</td><td></td>
      <td>${projTotals.PE}</td><td></td><td>${projTotals.PX}</td>
    </tr>`;

    html += `<tfoot><tr>
      <td></td><td><strong>TOTAL (A‚ÄìE)</strong></td><td></td>
      <td>${totals.A}</td><td></td><td>${totals.B}</td><td></td>
      <td>${totals.C}</td><td></td><td>totals.D}</td><td></td>
      <td>${totals.E}</td><td></td><td></td>
    </tr></tfoot></table>`;

    // analytics cards (added inside page 1)
    let totalA = 0, totalSat = 0;
    Object.values(subjects).forEach(x => { totalA += x.A; totalSat += x.sat; });
    let mean = totalSat ? (totalA / totalSat * 100) : 0;
    let comment = mean >= 40 ? 'üèÜ Excellent Performance' : (mean >= 25 ? 'üìà Good Performance' : 'üìâ Needs Improvement');

    html += `<div class="summary-cards">
      <div class="card">üéì School %A : ${mean.toFixed(1)}%</div>
      <div class="card">${comment}</div>
    </div>`;

    return html;
  }

  // -------------------- BUILD GENDER TABLE (title only) --------------------
  function buildGenderTableHTML() {
    let grand = { MA:0, MB:0, MC:0, MD:0, ME:0, FA:0, FB:0, FC:0, FD:0, FE:0 };

    let html = `<h3 style="color:#0a2c4e; border-left: 6px solid #2563eb; padding-left: 12px; margin-bottom: 6px;">‚ö• TABLE 2: GENDER DISTRIBUTION BY SUBJECT</h3>`;
    html += `<table>
      <thead>
        <tr>
          <th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
          <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
        </tr>
      </thead>
      <tbody>`;

    Object.keys(gender).sort().forEach(s => {
      let g = gender[s];
      Object.keys(grand).forEach(k => grand[k] += g[k] || 0);
      html += `<tr>
        <td style="font-weight: 600;">${s}</td>
        <td>${g.MA || 0}</td><td>${g.MB || 0}</td><td>${g.MC || 0}</td><td>${g.MD || 0}</td><td>${g.ME || 0}</td>
        <td>${g.FA || 0}</td><td>${g.FB || 0}</td><td>${g.FC || 0}</td><td>${g.FD || 0}</td><td>${g.FE || 0}</td>
      </tr>`;
    });

    html += `<tfoot><tr>
      <td><strong>TOTAL</strong></td>
      <td>${grand.MA}</td><td>${grand.MB}</td><td>${grand.MC}</td><td>${grand.MD}</td><td>${grand.ME}</td>
      <td>${grand.FA}</td><td>${grand.FB}</td><td>${grand.FC}</td><td>${grand.FD}</td><td>${grand.FE}</td>
    </tr></tfoot></table>`;

    return html;
  }

  // -------------------- SIGNATURE BLOCK (reusable) --------------------
  function buildSignatureBlock() {
    return `<div class="signature-block">
      <div class="signature-line">
        <span style="font-weight: 700;">Signature:</span> ___________________________________<br>
        <span style="font-size: 12px; color: #2d4968;">Mawerere Francis ¬∑ In charge Students Data</span>
      </div>
      <div class="signature-contact">
        üìû 0788222315 &nbsp; ‚úâÔ∏è mawererefrancis@gmail.com
      </div>
    </div>`;
  }

  // -------------------- PRINT --------------------
  function printReport() { window.print(); }

  // -------------------- PDF --------------------
  function downloadPDF() {
    const element = document.getElementById('reportArea');
    element.classList.add('pdf-export-mode');
    html2pdf().set({
      margin: [8, 10, 5, 10],
      filename: 'UNEB_ANALYSIS_MAWERERE.pdf',
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 0.58, letterRendering: true, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    }).from(element).save().then(() => {
      element.classList.remove('pdf-export-mode');
    });
  }

  // -------------------- EXCEL (two tables) --------------------
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const subjectTable = document.querySelector('#reportArea .print-page:first-child table');
    if (subjectTable) {
      const wsSub = XLSX.utils.table_to_sheet(subjectTable);
      XLSX.utils.sheet_add_aoa(wsSub, [['SUBJECT ACHIEVEMENT SUMMARY']], { origin: 'A1' });
      XLSX.utils.book_append_sheet(wb, wsSub, 'Subject Summary');
    }
    const genderTable = document.querySelector('#reportArea .print-page:last-child table');
    if (genderTable) {
      const wsGen = XLSX.utils.table_to_sheet(genderTable);
      XLSX.utils.sheet_add_aoa(wsGen, [['GENDER DISTRIBUTION']], { origin: 'A1' });
      XLSX.utils.book_append_sheet(wb, wsGen, 'Gender Summary');
    }
    const school = document.getElementById('schoolName').value || 'SCHOOL';
    const year = document.getElementById('year').value || '';
    XLSX.writeFile(wb, `UNEB_${school.replace(/\s/g,'_')}_${year || 'report'}.xlsx`);
  }

  // -------------------- INDIVIDUAL LEARNER TESTIMONIALS (EXCEL) --------------------
  function generateTestimonials() {
    if (!lastLoadedRows || lastLoadedRows.length === 0) {
      alert('Please generate the report first (upload Excel and click GENERATE REPORT)');
      return;
    }

    const wb = XLSX.utils.book_new();
    const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
    const year = document.getElementById('year').value || 'YEAR';

    lastLoadedRows.forEach((row, idx) => {
      // extract candidate details
      const indexNo = row.IndexNo || `CANDIDATE_${idx+1}`;
      const name = row.Candidate_Name || '';
      const sex = row.Sex || '';
      const result = row.Result || '';
      const project = row['PROJECT WORK'] || 'X';
      const achievements = String(row['SUBJECT ACHIEVEMENTS'] || '').trim();

      // build subject-grade pairs
      const subjectList = [];
      if (achievements) {
        achievements.split(' ').forEach(item => {
          if (item.includes('-')) {
            let [sub, grad] = item.split('-');
            subjectList.push([sub.trim(), grad.trim()]);
          }
        });
      }

      // ----- construct worksheet data (array of arrays) -----
      let wsData = [];

      // header
      wsData.push(['INDIVIDUAL LEARNER TESTIMONIAL']);
      wsData.push([`School: ${schoolName}`, `Year: ${year}`]);
      wsData.push([]);

      // candidate details
      wsData.push(['Candidate Index:', indexNo]);
      wsData.push(['Full Name:', name]);
      wsData.push(['Sex:', sex]);
      wsData.push(['Overall Result:', result]);
      wsData.push([]);

      // subject table header
      wsData.push(['SUBJECT', 'GRADE']);
      subjectList.forEach(([sub, grade]) => {
        wsData.push([sub, grade]);
      });
      wsData.push([]);
      wsData.push(['Project Work Grade:', project]);
      wsData.push([]);
      wsData.push([]);

      // HEAD TEACHER COMMENT & SIGNATURE BLOCK
      wsData.push(['HEAD TEACHER\'S COMMENT:  ___________________________________________']);
      wsData.push([]);
      wsData.push(['Head Teacher\'s Name:      ______________________________']);
      wsData.push(['Title:                   ______________________________']);
      wsData.push(['Rank:                   ______________________________']);
      wsData.push(['Signature:              ______________________________']);
      wsData.push([]);
      wsData.push(['Date:                   ______________________________']);

      // create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      // column widths (optional, makes it nicer)
      ws['!cols'] = [{ wch: 22 }, { wch: 32 }];
      
      // sheet name = indexNo (trim to 31 chars)
      let sheetName = String(indexNo).replace(/[\\*?:[\]/]/g, '_').slice(0, 31);
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    // add a cover sheet with summary? optional
    XLSX.writeFile(wb, `LEARNER_TESTIMONIALS_${schoolName.replace(/\s/g,'_')}_${year}.xlsx`);
  }

</script>
</body>
</html>
